/**
 * Name: main.js:qtext2/base
 * URL: http://qsf.ec.quoracdn.net/-3-main.js:qtext2.baseea4bef9a0c1310a8.js
 * Generated: 1480370004813472
 * Files: /third_party/rangy-core.js, /shared/rangy.js, /qtext2/constants.js, /qtext2/container.js, /qtext2/position.js, /qtext2/modifiers.js, /qtext2/span.js, /qtext2/undo.js, /qtext2/sections/plain.js, /qtext2/sections/code.js, /qtext2/sections/image.js, /qtext2/sections/horizontal_rule.js, /qtext2/sections/lists.js, /shared/embedly.js, /qtext2/sections/embed.js, /qtext2/section.js, /qtext2/formatting_state.js, /qtext2/selection.js, /qtext2/caret.js, /third_party/mutation-summary.js, /qtext2/mutations.js, /shared/parse_html.js, /qtext2/parser.js, /qtext2/command/base.js, /qtext2/command/backspace.js, /qtext2/command/code.js, /qtext2/command/copy.js, /qtext2/command/delete.js, /qtext2/command/indent.js, /qtext2/command/image.js, /qtext2/command/link.js, /qtext2/command/math.js, /qtext2/command/mention.js, /qtext2/command/paste.js, /qtext2/command/quote.js, /qtext2/command/return.js, /qtext2/command/soft_return.js, /qtext2/command/undoredo.js, /qtext2/command/video.js, /qtext2/commands.js, /qtext2/extension/tooltips.js, /qtext2/extension/autolist.js, /qtext2/extension/autolink.js, /qtext2/extension/typing_change_base.js, /qtext2/extension/ellipses.js, /qtext2/extension/hr.js, /qtext2/extension/undo_state.js, /qtext2/extension/mention.js, /qtext2/extension/non_editable_cursors.js, /qtext2/extension/smart_quotes.js, /qtext2/extension/double_space.js, /qtext2/extension/dashes.js, /qtext2/extension/arrows.js, /qtext2/extensions.js, /qtext2/base.js
 */
define("third_party/rangy-core",["shared/polyfills"],function e(require,exports,t){window["rangy"]=function(){var e="object",t="function",n="undefined";var i=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"];var r=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"];var s=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"];var o=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"];function a(n,i){var r=typeof n[i];return r==t||!!(r==e&&n[i])||r=="unknown"}function d(t,n){return!!(typeof t[n]==e&&t[n])}function c(e,t){return typeof e[t]!=n;
}function l(e){return function(t,n){var i=n.length;while(i--){if(!e(t,n[i])){return false}}return true}}var f=l(a);var h=l(d);var u=l(c);function p(e){return e&&f(e,o)&&u(e,s)}var g={version:"1.2.3",initialized:false,supported:true,util:{isHostMethod:a,isHostObject:d,isHostProperty:c,areHostMethods:f,areHostObjects:h,areHostProperties:u,isTextRange:p},features:{},modules:{},config:{alertOnWarn:false,preferTextRange:false}};function m(e){window.alert("Rangy not supported in your browser. Reason: "+e);g.initialized=true;g.supported=false}g.fail=m;function v(e){var t="Rangy warning: "+e;if(g.config.alertOnWarn){window.alert(t)}else if(typeof window.console!=n&&typeof window.console.log!=n){window.console.log(t)}}g.warn=v;if({}.hasOwnProperty){g.util.extend=function(e,t){for(var n in t){if(t.hasOwnProperty(n)){e[n]=t[n]}}}}else{m("hasOwnProperty not supported")}var x=[];var C=[];function S(){if(g.initialized){return}var e;var t=false,n=false;if(a(document,"createRange")){e=document.createRange();
if(f(e,r)&&u(e,i)){t=true}e.detach()}var s=d(document,"body")?document.body:document.getElementsByTagName("body")[0];if(s&&a(s,"createTextRange")){e=s.createTextRange();if(p(e)){n=true}}if(!t&&!n){m("Neither Range nor TextRange are implemented")}g.initialized=true;g.features={implementsDomRange:t,implementsTextRange:n};var o=C.concat(x);for(var c=0,l=o.length;c<l;++c){try{o[c](g)}catch(h){if(d(window,"console")&&a(window.console,"log")){window.console.log("Init listener threw an exception. Continuing.",h)}}}}g.init=S;g.addInitListener=function(e){if(g.initialized){e(g)}else{x.push(e)}};var b=[];g.addCreateMissingNativeApiListener=function(e){b.push(e)};function E(e){e=e||window;S();for(var t=0,n=b.length;t<n;++t){b[t](e)}}g.createMissingNativeApi=E;function _(e){this.name=e;this.initialized=false;this.supported=false}_.prototype.fail=function(e){this.initialized=true;this.supported=false;throw new Error("Module '"+this.name+"' failed to load: "+e)};_.prototype.warn=function(e){g.warn("Module "+this.name+": "+e);
};_.prototype.createError=function(e){return new Error("Error in Rangy "+this.name+" module: "+e)};g.createModule=function(e,t){var n=new _(e);g.modules[e]=n;C.push(function(e){t(e,n);n.initialized=true;n.supported=true})};g.requireModules=function(modules){for(var e=0,t=modules.length,n,i;e<t;++e){i=modules[e];n=g.modules[i];if(!n||!(n instanceof _)){throw new Error("Module '"+i+"' not found")}if(!n.supported){throw new Error("Module '"+i+"' not supported")}}};var y=false;var w=function(e){if(!y){y=true;if(!g.initialized){S()}}};if(typeof window==n){m("No window found");return}if(typeof document==n){m("No document found");return}if(a(document,"addEventListener")){document.addEventListener("DOMContentLoaded",w,false)}if(a(window,"addEventListener")){window.addEventListener("load",w,false)}else if(a(window,"attachEvent")){window.attachEvent("onload",w)}else{m("Window does not have required addEventListener or attachEvent method")}return g}();rangy.createModule("DomUtil",function(e,t){var n="undefined";
var i=e.util;if(!i.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])){t.fail("document missing a Node creation method")}if(!i.isHostMethod(document,"getElementsByTagName")){t.fail("document missing getElementsByTagName method")}var r=document.createElement("div");if(!i.areHostMethods(r,["insertBefore","appendChild","cloneNode"]||!i.areHostObjects(r,["previousSibling","nextSibling","childNodes","parentNode"]))){t.fail("Incomplete Element implementation")}if(!i.isHostProperty(r,"innerHTML")){t.fail("Element is missing innerHTML property")}var s=document.createTextNode("test");if(!i.areHostMethods(s,["splitText","deleteData","insertData","appendData","cloneNode"]||!i.areHostObjects(r,["previousSibling","nextSibling","childNodes","parentNode"])||!i.areHostProperties(s,["data"]))){t.fail("Incomplete Text Node implementation")}var o=function(e,t){var n=e.length;while(n--){if(e[n]===t){return true}}return false};function a(e){var t;return typeof e.namespaceURI==n||((t=e.namespaceURI)===null||t=="http://www.w3.org/1999/xhtml");
}function d(e){var t=e.parentNode;return t.nodeType==1?t:null}function c(e){var t=0;while(e=e.previousSibling){t++}return t}function l(e){var t;return p(e)?e.length:(t=e.childNodes)?t.length:0}function f(e,t){var n=[],i;for(i=e;i;i=i.parentNode){n.push(i)}for(i=t;i;i=i.parentNode){if(o(n,i)){return i}}return null}function h(e,t,n){var i=n?t:t.parentNode;while(i){if(i===e){return true}else{i=i.parentNode}}return false}function u(e,t,n){var i,r=n?e:e.parentNode;while(r){i=r.parentNode;if(i===t){return r}r=i}return null}function p(e){var t=e.nodeType;return t==3||t==4||t==8}function g(e,t){var n=t.nextSibling,i=t.parentNode;if(n){i.insertBefore(e,n)}else{i.appendChild(e)}return e}function m(e,t){var n=e.cloneNode(false);n.deleteData(0,t);e.deleteData(t,e.length-t);g(n,e);return n}function v(e){if(e.nodeType==9){return e}else if(typeof e.ownerDocument!=n){return e.ownerDocument}else if(typeof e.document!=n){return e.document}else if(e.parentNode){return v(e.parentNode)}else{throw new Error("getDocument: no document found for node");
}}function x(e){var t=v(e);if(typeof t.defaultView!=n){return t.defaultView}else if(typeof t.parentWindow!=n){return t.parentWindow}else{throw new Error("Cannot get a window object for node")}}function C(e){if(typeof e.contentDocument!=n){return e.contentDocument}else if(typeof e.contentWindow!=n){return e.contentWindow.document}else{throw new Error("getIframeWindow: No Document object found for iframe element")}}function S(e){if(typeof e.contentWindow!=n){return e.contentWindow}else if(typeof e.contentDocument!=n){return e.contentDocument.defaultView}else{throw new Error("getIframeWindow: No Window object found for iframe element")}}function b(e){return i.isHostObject(e,"body")?e.body:e.getElementsByTagName("body")[0]}function E(e){var t;while(t=e.parentNode){e=t}return e}function _(e,t,n,i){var r,s,o,a,d;if(e==n){return t===i?0:t<i?-1:1}else if(r=u(n,e,true)){return t<=c(r)?-1:1}else if(r=u(e,n,true)){return c(r)<i?-1:1}else{s=f(e,n);o=e===s?s:u(e,s,true);a=n===s?s:u(n,s,true);if(o===a){
throw new Error("comparePoints got to case 4 and childA and childB are the same!")}else{d=s.firstChild;while(d){if(d===o){return-1}else if(d===a){return 1}d=d.nextSibling}throw new Error("Should not be here!")}}}function y(e){var t=v(e).createDocumentFragment(),n;while(n=e.firstChild){t.appendChild(n)}return t}function w(e){if(!e){return"[No node]"}if(p(e)){return'"'+e.data+'"'}else if(e.nodeType==1){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">["+e.childNodes.length+"]"}else{return e.nodeName}}function T(e){this.root=e;this._next=e}T.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;var t,n;if(this._current){t=e.firstChild;if(t){this._next=t}else{n=null;while(e!==this.root&&!(n=e.nextSibling)){e=e.parentNode}this._next=n}}return this._current},detach:function(){this._current=this._next=this.root=null}};function N(e){return new T(e)}function q(e,t){this.node=e;this.offset=t}q.prototype={equals:function(e){return this.node===e.node&this.offset==e.offset;
},inspect:function(){return"[DomPosition("+w(this.node)+":"+this.offset+")]"}};function R(e){this.code=this[e];this.codeName=e;this.message="DOMException: "+this.codeName}R.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};R.prototype.toString=function(){return this.message};e.dom={arrayContains:o,isHtmlNamespace:a,parentElement:d,getNodeIndex:c,getNodeLength:l,getCommonAncestor:f,isAncestorOf:h,getClosestAncestorIn:u,isCharacterDataNode:p,insertAfter:g,splitDataNode:m,getDocument:v,getWindow:x,getIframeWindow:S,getIframeDocument:C,getBody:b,getRootContainer:E,comparePoints:_,inspectNode:w,fragmentFromNodeChildren:y,createIterator:N,DomPosition:q};e.DOMException=R});rangy.createModule("DomRange",function(e,t){e.requireModules(["DomUtil"]);var n=e.dom;var i=n.DomPosition;var r=e.DOMException;function s(e,t){return e.nodeType!=3&&(n.isAncestorOf(e,t.startContainer,true)||n.isAncestorOf(e,t.endContainer,true));
}function o(e){return n.getDocument(e.startContainer)}function a(e,t,n){var i=e._listeners[t];if(i){for(var r=0,s=i.length;r<s;++r){i[r].call(e,{target:e,args:n})}}}function d(e){return new i(e.parentNode,n.getNodeIndex(e))}function c(e){return new i(e.parentNode,n.getNodeIndex(e)+1)}function l(e,t,i){var r=e.nodeType==11?e.firstChild:e;if(n.isCharacterDataNode(t)){if(i==t.length){n.insertAfter(e,t)}else{t.parentNode.insertBefore(e,i==0?t:n.splitDataNode(t,i))}}else if(i>=t.childNodes.length){t.appendChild(e)}else{t.insertBefore(e,t.childNodes[i])}return r}function f(e){var t;for(var n,i=o(e.range).createDocumentFragment(),s;n=e.next();){t=e.isPartiallySelectedSubtree();n=n.cloneNode(!t);if(t){s=e.getSubtreeIterator();n.appendChild(f(s));s.detach(true)}if(n.nodeType==10){throw new r("HIERARCHY_REQUEST_ERR")}i.appendChild(n)}return i}function h(e,t,i){var r,s;i=i||{stop:false};for(var o,a;o=e.next();){if(e.isPartiallySelectedSubtree()){if(t(o)===false){i.stop=true;return}else{a=e.getSubtreeIterator();
h(a,t,i);a.detach(true);if(i.stop){return}}}else{r=n.createIterator(o);while(s=r.next()){if(t(s)===false){i.stop=true;return}}}}}function u(e){var t;while(e.next()){if(e.isPartiallySelectedSubtree()){t=e.getSubtreeIterator();u(t);t.detach(true)}else{e.remove()}}}function p(e){for(var t,n=o(e.range).createDocumentFragment(),i;t=e.next();){if(e.isPartiallySelectedSubtree()){t=t.cloneNode(false);i=e.getSubtreeIterator();t.appendChild(p(i));i.detach(true)}else{e.remove()}if(t.nodeType==10){throw new r("HIERARCHY_REQUEST_ERR")}n.appendChild(t)}return n}function g(e,t,n){var i=!!(t&&t.length),r;var s=!!n;if(i){r=new RegExp("^("+t.join("|")+")$")}var o=[];h(new v(e,false),function(e){if((!i||r.test(e.nodeType))&&(!s||n(e))){o.push(e)}});return o}function m(e){var t=typeof e.getName=="undefined"?"Range":e.getName();return"["+t+"("+n.inspectNode(e.startContainer)+":"+e.startOffset+", "+n.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function v(e,t){this.range=e;this.clonePartiallySelectedTextNodes=t;
if(!e.collapsed){this.sc=e.startContainer;this.so=e.startOffset;this.ec=e.endContainer;this.eo=e.endOffset;var i=e.commonAncestorContainer;if(this.sc===this.ec&&n.isCharacterDataNode(this.sc)){this.isSingleCharacterDataNode=true;this._first=this._last=this._next=this.sc}else{this._first=this._next=this.sc===i&&!n.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:n.getClosestAncestorIn(this.sc,i,true);this._last=this.ec===i&&!n.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:n.getClosestAncestorIn(this.ec,i,true)}}}v.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:false,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;if(e){this._next=e!==this._last?e.nextSibling:null;if(n.isCharacterDataNode(e)&&this.clonePartiallySelectedTextNodes){if(e===this.ec){(e=e.cloneNode(true)).deleteData(this.eo,e.length-this.eo)}if(this._current===this.sc){(e=e.cloneNode(true)).deleteData(0,this.so);
}}}return e},remove:function(){var e=this._current,t,i;if(n.isCharacterDataNode(e)&&(e===this.sc||e===this.ec)){t=e===this.sc?this.so:0;i=e===this.ec?this.eo:e.length;if(t!=i){e.deleteData(t,i-t)}}else{if(e.parentNode){e.parentNode.removeChild(e)}else{}}},isPartiallySelectedSubtree:function(){var e=this._current;return s(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode){e=this.range.cloneRange();e.collapse()}else{e=new ce(o(this.range));var t=this._current;var i=t,r=0,s=t,a=n.getNodeLength(t);if(n.isAncestorOf(t,this.sc,true)){i=this.sc;r=this.so}if(n.isAncestorOf(t,this.ec,true)){s=this.ec;a=this.eo}ae(e,i,r,s,a)}return new v(e,this.clonePartiallySelectedTextNodes)},detach:function(e){if(e){this.range.detach()}this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};function x(e){this.code=this[e];this.codeName=e;this.message="RangeException: "+this.codeName}x.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2
};x.prototype.toString=function(){return this.message};function C(e,t,n){this.nodes=g(e,t,n);this._next=this.nodes[0];this._position=0}C.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){this._current=this._next;this._next=this.nodes[++this._position];return this._current},detach:function(){this._current=this._next=this.nodes=null}};var S=[1,3,4,5,7,8,10];var b=[2,9,11];var E=[5,6,10,12];var _=[1,3,4,5,7,8,10,11];var y=[1,3,4,5,7,8];function w(e){return function(t,i){var r,s=i?t:t.parentNode;while(s){r=s.nodeType;if(n.arrayContains(e,r)){return s}s=s.parentNode}return null}}var T=n.getRootContainer;var N=w([9,11]);var q=w(E);var R=w([6,10,12]);function O(e,t){if(R(e,t)){throw new x("INVALID_NODE_TYPE_ERR")}}function D(e){if(!e.startContainer){throw new r("INVALID_STATE_ERR")}}function M(e,t){if(!n.arrayContains(t,e.nodeType)){throw new x("INVALID_NODE_TYPE_ERR")}}function I(e,t){if(t<0||t>(n.isCharacterDataNode(e)?e.length:e.childNodes.length)){throw new r("INDEX_SIZE_ERR");
}}function A(e,t){if(N(e,true)!==N(t,true)){throw new r("WRONG_DOCUMENT_ERR")}}function P(e){if(q(e,true)){throw new r("NO_MODIFICATION_ALLOWED_ERR")}}function k(e,t){if(!e){throw new r(t)}}function L(e){return!n.arrayContains(b,e.nodeType)&&!N(e,true)}function B(e,t){return t<=(n.isCharacterDataNode(e)?e.length:e.childNodes.length)}function U(e){return!!e.startContainer&&!!e.endContainer&&!L(e.startContainer)&&!L(e.endContainer)&&B(e.startContainer,e.startOffset)&&B(e.endContainer,e.endOffset)}function H(e){D(e);if(!U(e)){throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}}var F=document.createElement("style");var Q=false;try{F.innerHTML="<b>x</b>";Q=F.firstChild.nodeType==3}catch(V){}e.features.htmlParsingConforms=Q;var W=Q?function(e){var t=this.startContainer;var i=n.getDocument(t);if(!t){throw new r("INVALID_STATE_ERR")}var s=null;if(t.nodeType==1){s=t}else if(n.isCharacterDataNode(t)){s=n.parentElement(t)}if(s===null||s.nodeName=="HTML"&&n.isHtmlNamespace(n.getDocument(s).documentElement)&&n.isHtmlNamespace(s)){
s=i.createElement("body")}else{s=s.cloneNode(false)}s.innerHTML=e;return n.fragmentFromNodeChildren(s)}:function(e){D(this);var t=o(this);var i=t.createElement("body");i.innerHTML=e;return n.fragmentFromNodeChildren(i)};var j=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"];var Y=0,z=1,X=2,J=3;var G=0,K=1,Z=2,ee=3;function te(){}te.prototype={attachListener:function(e,t){this._listeners[e].push(t)},compareBoundaryPoints:function(e,t){H(this);A(this.startContainer,t.startContainer);var i,r,s,o;var a=e==J||e==Y?"start":"end";var d=e==z||e==Y?"start":"end";i=this[a+"Container"];r=this[a+"Offset"];s=t[d+"Container"];o=t[d+"Offset"];return n.comparePoints(i,r,s,o)},insertNode:function(e){H(this);M(e,_);P(this.startContainer);if(n.isAncestorOf(e,this.startContainer,true)){throw new r("HIERARCHY_REQUEST_ERR")}var t=l(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){H(this);var e,t;if(this.collapsed){return o(this).createDocumentFragment();
}else{if(this.startContainer===this.endContainer&&n.isCharacterDataNode(this.startContainer)){e=this.startContainer.cloneNode(true);e.data=e.data.slice(this.startOffset,this.endOffset);t=o(this).createDocumentFragment();t.appendChild(e);return t}else{var i=new v(this,true);e=f(i);i.detach()}return e}},canSurroundContents:function(){H(this);P(this.startContainer);P(this.endContainer);var e=new v(this,true);var t=e._first&&s(e._first,this)||e._last&&s(e._last,this);e.detach();return!t},surroundContents:function(e){M(e,y);if(!this.canSurroundContents()){throw new x("BAD_BOUNDARYPOINTS_ERR")}var t=this.extractContents();if(e.hasChildNodes()){while(e.lastChild){e.removeChild(e.lastChild)}}l(e,this.startContainer,this.startOffset);e.appendChild(t);this.selectNode(e)},cloneRange:function(){H(this);var e=new ce(o(this));var t=j.length,n;while(t--){n=j[t];e[n]=this[n]}return e},toString:function(){H(this);var e=this.startContainer;if(e===this.endContainer&&n.isCharacterDataNode(e)){return e.nodeType==3||e.nodeType==4?e.data.slice(this.startOffset,this.endOffset):"";
}else{var t=[],i=new v(this,true);h(i,function(e){if(e.nodeType==3||e.nodeType==4){t.push(e.data)}});i.detach();return t.join("")}},compareNode:function(e){H(this);var t=e.parentNode;var i=n.getNodeIndex(e);if(!t){throw new r("NOT_FOUND_ERR")}var s=this.comparePoint(t,i),o=this.comparePoint(t,i+1);if(s<0){return o>0?Z:G}else{return o>0?K:ee}},comparePoint:function(e,t){H(this);k(e,"HIERARCHY_REQUEST_ERR");A(e,this.startContainer);if(n.comparePoints(e,t,this.startContainer,this.startOffset)<0){return-1}else if(n.comparePoints(e,t,this.endContainer,this.endOffset)>0){return 1}return 0},createContextualFragment:W,toHtml:function(){H(this);var e=o(this).createElement("div");e.appendChild(this.cloneContents());return e.innerHTML},intersectsNode:function(e,t){H(this);k(e,"NOT_FOUND_ERR");if(n.getDocument(e)!==o(this)){return false}var i=e.parentNode,r=n.getNodeIndex(e);k(i,"NOT_FOUND_ERR");var s=n.comparePoints(i,r,this.endContainer,this.endOffset),a=n.comparePoints(i,r+1,this.startContainer,this.startOffset);
return t?s<=0&&a>=0:s<0&&a>0},isPointInRange:function(e,t){H(this);k(e,"HIERARCHY_REQUEST_ERR");A(e,this.startContainer);return n.comparePoints(e,t,this.startContainer,this.startOffset)>=0&&n.comparePoints(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e,t){H(this);if(o(e)!=o(this)){throw new r("WRONG_DOCUMENT_ERR")}var i=n.comparePoints(this.startContainer,this.startOffset,e.endContainer,e.endOffset),s=n.comparePoints(this.endContainer,this.endOffset,e.startContainer,e.startOffset);return t?i<=0&&s>=0:i<0&&s>0},intersection:function(e){if(this.intersectsRange(e)){var t=n.comparePoints(this.startContainer,this.startOffset,e.startContainer,e.startOffset),i=n.comparePoints(this.endContainer,this.endOffset,e.endContainer,e.endOffset);var r=this.cloneRange();if(t==-1){r.setStart(e.startContainer,e.startOffset)}if(i==1){r.setEnd(e.endContainer,e.endOffset)}return r}return null},union:function(e){if(this.intersectsRange(e,true)){var t=this.cloneRange();if(n.comparePoints(e.startContainer,e.startOffset,this.startContainer,this.startOffset)==-1){
t.setStart(e.startContainer,e.startOffset)}if(n.comparePoints(e.endContainer,e.endOffset,this.endContainer,this.endOffset)==1){t.setEnd(e.endContainer,e.endOffset)}return t}else{throw new x("Ranges do not intersect")}},containsNode:function(e,t){if(t){return this.intersectsNode(e,false)}else{return this.compareNode(e)==ee}},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,n.getNodeLength(e))<=0},containsRange:function(e){return this.intersection(e).equals(e)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var i=n.pop();t.setEnd(i,i.length);var r=this.containsRange(t);t.detach();return r}else{return this.containsNodeContents(e)}},createNodeIterator:function(e,t){H(this);return new C(this,e,t)},getNodes:function(e,t){H(this);return g(this,e,t)},getDocument:function(){return o(this)},collapseBefore:function(e){D(this);this.setEndBefore(e);this.collapse(false)},collapseAfter:function(e){
D(this);this.setStartAfter(e);this.collapse(true)},getName:function(){return"DomRange"},equals:function(e){return ce.rangesEqual(this,e)},isValid:function(){return U(this)},inspect:function(){return m(this)}};function ne(e){e.START_TO_START=Y;e.START_TO_END=z;e.END_TO_END=X;e.END_TO_START=J;e.NODE_BEFORE=G;e.NODE_AFTER=K;e.NODE_BEFORE_AND_AFTER=Z;e.NODE_INSIDE=ee}function ie(e){ne(e);ne(e.prototype)}function re(e,t){return function(){H(this);var i=this.startContainer,r=this.startOffset,s=this.commonAncestorContainer;var o=new v(this,true);var a,d;if(i!==s){a=n.getClosestAncestorIn(i,s,true);d=c(a);i=d.node;r=d.offset}h(o,P);o.reset();var l=e(o);o.detach();t(this,i,r,i,r);return l}}function se(t,i,r){function o(e,t){return function(n){D(this);M(n,S);M(T(n),b);var i=(e?d:c)(n);(t?a:l)(this,i.node,i.offset)}}function a(e,t,r){var s=e.endContainer,o=e.endOffset;if(t!==e.startContainer||r!==e.startOffset){if(T(t)!=T(s)||n.comparePoints(t,r,s,o)==1){s=t;o=r}i(e,t,r,s,o)}}function l(e,t,r){var s=e.startContainer,o=e.startOffset;
if(t!==e.endContainer||r!==e.endOffset){if(T(t)!=T(s)||n.comparePoints(t,r,s,o)==-1){s=t;o=r}i(e,s,o,t,r)}}function f(e,t,n){if(t!==e.startContainer||n!==e.startOffset||t!==e.endContainer||n!==e.endOffset){i(e,t,n,t,n)}}t.prototype=new te;e.util.extend(t.prototype,{setStart:function(e,t){D(this);O(e,true);I(e,t);a(this,e,t)},setEnd:function(e,t){D(this);O(e,true);I(e,t);l(this,e,t)},setStartBefore:o(true,true),setStartAfter:o(false,true),setEndBefore:o(true,false),setEndAfter:o(false,false),collapse:function(e){H(this);if(e){i(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset)}else{i(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)}},selectNodeContents:function(e){D(this);O(e,true);i(this,e,0,e,n.getNodeLength(e))},selectNode:function(e){D(this);O(e,false);M(e,S);var t=d(e),n=c(e);i(this,t.node,t.offset,n.node,n.offset)},extractContents:re(p,i),deleteContents:re(u,i),canSurroundContents:function(){H(this);P(this.startContainer);P(this.endContainer);
var e=new v(this,true);var t=e._first&&s(e._first,this)||e._last&&s(e._last,this);e.detach();return!t},detach:function(){r(this)},splitBoundaries:function(){H(this);var e=this.startContainer,t=this.startOffset,r=this.endContainer,s=this.endOffset;var o=e===r;if(n.isCharacterDataNode(r)&&s>0&&s<r.length){n.splitDataNode(r,s)}if(n.isCharacterDataNode(e)&&t>0&&t<e.length){e=n.splitDataNode(e,t);if(o){s-=t;r=e}else if(r==e.parentNode&&s>=n.getNodeIndex(e)){s++}t=0}i(this,e,t,r,s)},normalizeBoundaries:function(){H(this);var e=this.startContainer,t=this.startOffset,r=this.endContainer,s=this.endOffset;var o=function(e){var t=e.nextSibling;if(t&&t.nodeType==e.nodeType){r=e;s=e.length;e.appendData(t.data);t.parentNode.removeChild(t)}};var a=function(i){var o=i.previousSibling;if(o&&o.nodeType==i.nodeType){e=i;var a=i.length;t=o.length;i.insertData(0,o.data);o.parentNode.removeChild(o);if(e==r){s+=t;r=e}else if(r==i.parentNode){var d=n.getNodeIndex(i);if(s==d){r=i;s=a}else if(s>d){s--}}}};var d=true;
if(n.isCharacterDataNode(r)){if(r.length==s){o(r)}}else{if(s>0){var c=r.childNodes[s-1];if(c&&n.isCharacterDataNode(c)){o(c)}}d=!this.collapsed}if(d){if(n.isCharacterDataNode(e)){if(t==0){a(e)}}else{if(t<e.childNodes.length){var l=e.childNodes[t];if(l&&n.isCharacterDataNode(l)){a(l)}}}}else{e=r;t=s}i(this,e,t,r,s)},collapseToPoint:function(e,t){D(this);O(e,true);I(e,t);f(this,e,t)}});ie(t)}function oe(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset;e.commonAncestorContainer=e.collapsed?e.startContainer:n.getCommonAncestor(e.startContainer,e.endContainer)}function ae(e,t,n,i,r){var s=e.startContainer!==t||e.startOffset!==n;var o=e.endContainer!==i||e.endOffset!==r;e.startContainer=t;e.startOffset=n;e.endContainer=i;e.endOffset=r;oe(e);a(e,"boundarychange",{startMoved:s,endMoved:o})}function de(e){D(e);e.startContainer=e.startOffset=e.endContainer=e.endOffset=null;e.collapsed=e.commonAncestorContainer=null;a(e,"detach",null);e._listeners=null}function ce(e){this.startContainer=e;
this.startOffset=0;this.endContainer=e;this.endOffset=0;this._listeners={boundarychange:[],detach:[]};oe(this)}se(ce,ae,de);e.rangePrototype=te.prototype;ce.rangeProperties=j;ce.RangeIterator=v;ce.copyComparisonConstants=ie;ce.createPrototypeRange=se;ce.inspect=m;ce.getRangeDocument=o;ce.rangesEqual=function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset};e.DomRange=ce;e.RangeException=x});rangy.createModule("WrappedRange",function(e,t){e.requireModules(["DomUtil","DomRange"]);var n;var i=e.dom;var r=i.DomPosition;var s=e.DomRange;function o(e){var t=e.parentElement();var n=e.duplicate();n.collapse(true);var r=n.parentElement();n=e.duplicate();n.collapse(false);var s=n.parentElement();var o=r==s?r:i.getCommonAncestor(r,s);return o==t?o:i.getCommonAncestor(t,o)}function a(e){return e.compareEndPoints("StartToEnd",e)==0}function d(e,t,n,s){var o=e.duplicate();o.collapse(n);var a=o.parentElement();if(!i.isAncestorOf(t,a,true)){
a=t}if(!a.canHaveHTML){return new r(a.parentNode,i.getNodeIndex(a))}var d=i.getDocument(a).createElement("span");var c,l=n?"StartToStart":"StartToEnd";var f,h,u,p;do{a.insertBefore(d,d.previousSibling);o.moveToElementText(d)}while((c=o.compareEndPoints(l,e))>0&&d.previousSibling);p=d.nextSibling;if(c==-1&&p&&i.isCharacterDataNode(p)){o.setEndPoint(n?"EndToStart":"EndToEnd",e);var g;if(/[\r\n]/.test(p.data)){var m=o.duplicate();var v=m.text.replace(/\r\n/g,"\r").length;g=m.moveStart("character",v);while((c=m.compareEndPoints("StartToEnd",m))==-1){g++;m.moveStart("character",1)}}else{g=o.text.length}u=new r(p,g)}else{f=(s||!n)&&d.previousSibling;h=(s||n)&&d.nextSibling;if(h&&i.isCharacterDataNode(h)){u=new r(h,0)}else if(f&&i.isCharacterDataNode(f)){u=new r(f,f.length)}else{u=new r(a,i.getNodeIndex(d))}}d.parentNode.removeChild(d);return u}function c(e,t){var n,r,s=e.offset;var o=i.getDocument(e.node);var a,d,c=o.body.createTextRange();var l=i.isCharacterDataNode(e.node);if(l){n=e.node;r=n.parentNode;
}else{d=e.node.childNodes;n=s<d.length?d[s]:null;r=e.node}a=o.createElement("span");a.innerHTML="&#feff;";if(n){r.insertBefore(a,n)}else{r.appendChild(a)}c.moveToElementText(a);c.collapse(!t);r.removeChild(a);if(l){c[t?"moveStart":"moveEnd"]("character",s)}return c}if(e.features.implementsDomRange&&(!e.features.implementsTextRange||!e.config.preferTextRange)){(function(){var t;var r=s.rangeProperties;var o;function a(e){var t=r.length,n;while(t--){n=r[t];e[n]=e.nativeRange[n]}}function d(e,t,n,i,r){var s=e.startContainer!==t||e.startOffset!=n;var o=e.endContainer!==i||e.endOffset!=r;if(s||o){e.setEnd(i,r);e.setStart(t,n)}}function c(e){e.nativeRange.detach();e.detached=true;var t=r.length,n;while(t--){n=r[t];e[n]=null}}var l;n=function(e){if(!e){throw new Error("Range must be specified")}this.nativeRange=e;a(this)};s.createPrototypeRange(n,d,c);t=n.prototype;t.selectNode=function(e){this.nativeRange.selectNode(e);a(this)};t.deleteContents=function(){this.nativeRange.deleteContents();a(this);
};t.extractContents=function(){var e=this.nativeRange.extractContents();a(this);return e};t.cloneContents=function(){return this.nativeRange.cloneContents()};t.surroundContents=function(e){this.nativeRange.surroundContents(e);a(this)};t.collapse=function(e){this.nativeRange.collapse(e);a(this)};t.cloneRange=function(){return new n(this.nativeRange.cloneRange())};t.refresh=function(){a(this)};t.toString=function(){return this.nativeRange.toString()};var f=document.createTextNode("test");i.getBody(document).appendChild(f);var h=document.createRange();h.setStart(f,0);h.setEnd(f,0);try{h.setStart(f,1);o=true;t.setStart=function(e,t){this.nativeRange.setStart(e,t);a(this)};t.setEnd=function(e,t){this.nativeRange.setEnd(e,t);a(this)};l=function(e){return function(t){this.nativeRange[e](t);a(this)}}}catch(u){o=false;t.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t);this.nativeRange.setStart(e,t)}a(this)};t.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t);
}catch(n){this.nativeRange.setStart(e,t);this.nativeRange.setEnd(e,t)}a(this)};l=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(i){this.nativeRange[t](n);this.nativeRange[e](n)}a(this)}}}t.setStartBefore=l("setStartBefore","setEndBefore");t.setStartAfter=l("setStartAfter","setEndAfter");t.setEndBefore=l("setEndBefore","setStartBefore");t.setEndAfter=l("setEndAfter","setStartAfter");h.selectNodeContents(f);if(h.startContainer==f&&h.endContainer==f&&h.startOffset==0&&h.endOffset==f.length){t.selectNodeContents=function(e){this.nativeRange.selectNodeContents(e);a(this)}}else{t.selectNodeContents=function(e){this.setStart(e,0);this.setEnd(e,s.getEndOffset(e))}}h.selectNodeContents(f);h.setEnd(f,3);var p=document.createRange();p.selectNodeContents(f);p.setEnd(f,4);p.setStart(f,2);if(h.compareBoundaryPoints(h.START_TO_END,p)==-1&h.compareBoundaryPoints(h.END_TO_START,p)==1){t.compareBoundaryPoints=function(e,t){t=t.nativeRange||t;if(e==t.START_TO_END){e=t.END_TO_START}else if(e==t.END_TO_START){
e=t.START_TO_END}return this.nativeRange.compareBoundaryPoints(e,t)}}else{t.compareBoundaryPoints=function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)}}if(e.util.isHostMethod(h,"createContextualFragment")){t.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}}i.getBody(document).removeChild(f);h.detach();p.detach()})();e.createNativeRange=function(e){e=e||document;return e.createRange()}}else if(e.features.implementsTextRange){n=function(e){this.textRange=e;this.refresh()};n.prototype=new s(document);n.prototype.refresh=function(){var e,t;var n=o(this.textRange);if(a(this.textRange)){t=e=d(this.textRange,n,true,true)}else{e=d(this.textRange,n,true,false);t=d(this.textRange,n,false,false)}this.setStart(e.node,e.offset);this.setEnd(t.node,t.offset)};s.copyComparisonConstants(n);var l=function(){return this}();if(typeof l.Range=="undefined"){l.Range=n}e.createNativeRange=function(e){e=e||document;return e.body.createTextRange();
}}if(e.features.implementsTextRange){n.rangeToTextRange=function(e){if(e.collapsed){var t=c(new r(e.startContainer,e.startOffset),true);return t}else{var n=c(new r(e.startContainer,e.startOffset),true);var s=c(new r(e.endContainer,e.endOffset),false);var o=i.getDocument(e.startContainer).body.createTextRange();o.setEndPoint("StartToStart",n);o.setEndPoint("EndToEnd",s);return o}}}n.prototype.getName=function(){return"WrappedRange"};e.WrappedRange=n;e.createRange=function(t){t=t||document;return new n(e.createNativeRange(t))};e.createRangyRange=function(e){e=e||document;return new s(e)};e.createIframeRange=function(t){return e.createRange(i.getIframeDocument(t))};e.createIframeRangyRange=function(t){return e.createRangyRange(i.getIframeDocument(t))};e.addCreateMissingNativeApiListener(function(t){var n=t.document;if(typeof n.createRange=="undefined"){n.createRange=function(){return e.createRange(this)}}n=t=null})});rangy.createModule("WrappedSelection",function(e,t){e.requireModules(["DomUtil","DomRange","WrappedRange"]);
e.config.checkSelectionRanges=true;var n="boolean",i="_rangySelection",r=e.dom,s=e.util,o=e.DomRange,a=e.WrappedRange,d=e.DOMException,c=r.DomPosition,l,f,h="Control";function u(e){return(e||window).getSelection()}function p(e){return(e||window).document.selection}var g=e.util.isHostMethod(window,"getSelection"),m=e.util.isHostObject(document,"selection");var v=m&&(!g||e.config.preferTextRange);if(v){l=p;e.isSelectionValid=function(e){var t=(e||window).document,n=t.selection;return n.type!="None"||r.getDocument(n.createRange().parentElement())==t}}else if(g){l=u;e.isSelectionValid=function(){return true}}else{t.fail("Neither document.selection or window.getSelection() detected.")}e.getNativeSelection=l;var x=l();var C=e.createNativeRange(document);var S=r.getBody(document);var b=s.areHostObjects(x,["anchorNode","focusNode"]&&s.areHostProperties(x,["anchorOffset","focusOffset"]));e.features.selectionHasAnchorAndFocus=b;var E=s.isHostMethod(x,"extend");e.features.selectionHasExtend=E;var _=typeof x.rangeCount=="number";
e.features.selectionHasRangeCount=_;var y=false;var w=true;if(s.areHostMethods(x,["addRange","getRangeAt","removeAllRanges"])&&typeof x.rangeCount=="number"&&e.features.implementsDomRange){(function(){var e=document.createElement("iframe");e.frameBorder=0;e.style.position="absolute";e.style.left="-10000px";S.appendChild(e);var t=r.getIframeDocument(e);t.open();t.write("<html><head></head><body>12</body></html>");t.close();var n=r.getIframeWindow(e).getSelection();var i=t.documentElement;var s=i.lastChild,o=s.firstChild;var a=t.createRange();a.setStart(o,1);a.collapse(true);n.addRange(a);w=n.rangeCount==1;n.removeAllRanges();var d=a.cloneRange();a.setStart(o,0);d.setEnd(o,2);n.addRange(a);n.addRange(d);y=n.rangeCount==2;a.detach();d.detach();S.removeChild(e)})()}e.features.selectionSupportsMultipleRanges=y;e.features.collapsedNonEditableSelectionsSupported=w;var T=false,N;if(S&&s.isHostMethod(S,"createControlRange")){N=S.createControlRange();if(s.areHostProperties(N,["item","add"])){T=true;
}}e.features.implementsControlRange=T;if(b){f=function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}}else{f=function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:false}}function q(e,t,n){var i=n?"end":"start",r=n?"start":"end";e.anchorNode=t[i+"Container"];e.anchorOffset=t[i+"Offset"];e.focusNode=t[r+"Container"];e.focusOffset=t[r+"Offset"]}function R(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode;e.anchorOffset=t.anchorOffset;e.focusNode=t.focusNode;e.focusOffset=t.focusOffset}function O(e){e.anchorNode=e.focusNode=null;e.anchorOffset=e.focusOffset=0;e.rangeCount=0;e.isCollapsed=true;e._ranges.length=0}function D(t){var n;if(t instanceof o){n=t._selectionNativeRange;if(!n){n=e.createNativeRange(r.getDocument(t.startContainer));n.setEnd(t.endContainer,t.endOffset);n.setStart(t.startContainer,t.startOffset);t._selectionNativeRange=n;t.attachListener("detach",function(){this._selectionNativeRange=null})}}else if(t instanceof a){n=t.nativeRange;
}else if(e.features.implementsDomRange&&t instanceof r.getWindow(t.startContainer).Range){n=t}return n}function M(e){if(!e.length||e[0].nodeType!=1){return false}for(var t=1,n=e.length;t<n;++t){if(!r.isAncestorOf(e[0],e[t])){return false}}return true}function I(e){var t=e.getNodes();if(!M(t)){throw new Error("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element")}return t[0]}function A(e){return!!e&&typeof e.text!="undefined"}function P(e,t){var n=new a(t);e._ranges=[n];q(e,n,false);e.rangeCount=1;e.isCollapsed=n.collapsed}function k(t){t._ranges.length=0;if(t.docSelection.type=="None"){O(t)}else{var n=t.docSelection.createRange();if(A(n)){P(t,n)}else{t.rangeCount=n.length;var i,s=r.getDocument(n.item(0));for(var o=0;o<t.rangeCount;++o){i=e.createRange(s);i.selectNode(n.item(o));t._ranges.push(i)}t.isCollapsed=t.rangeCount==1&&t._ranges[0].collapsed;q(t,t._ranges[t.rangeCount-1],false)}}}function L(e,t){var n=e.docSelection.createRange();var i=I(t);var s=r.getDocument(n.item(0));
var o=r.getBody(s).createControlRange();for(var a=0,d=n.length;a<d;++a){o.add(n.item(a))}try{o.add(i)}catch(c){throw new Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}o.select();k(e)}var B;if(s.isHostMethod(x,"getRangeAt")){B=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}}else if(b){B=function(t){var n=r.getDocument(t.anchorNode);var i=e.createRange(n);i.setStart(t.anchorNode,t.anchorOffset);i.setEnd(t.focusNode,t.focusOffset);if(i.collapsed!==this.isCollapsed){i.setStart(t.focusNode,t.focusOffset);i.setEnd(t.anchorNode,t.anchorOffset)}return i}}function U(e,t,n){this.nativeSelection=e;this.docSelection=t;this._ranges=[];this.win=n;this.refresh()}e.getSelection=function(e){e=e||window;var t=e[i];var n=l(e),r=m?p(e):null;if(t){t.nativeSelection=n;t.docSelection=r;t.refresh(e)}else{t=new U(n,r,e);e[i]=t}return t};e.getIframeSelection=function(t){return e.getSelection(r.getIframeWindow(t))};var H=U.prototype;
function F(e,t){var n=r.getDocument(t[0].startContainer);var i=r.getBody(n).createControlRange();for(var s=0,o;s<rangeCount;++s){o=I(t[s]);try{i.add(o)}catch(a){throw new Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}i.select();k(e)}if(!v&&b&&s.areHostMethods(x,["removeAllRanges","addRange"])){H.removeAllRanges=function(){this.nativeSelection.removeAllRanges();O(this)};var Q=function(t,n){var i=o.getRangeDocument(n);var r=e.createRange(i);r.collapseToPoint(n.endContainer,n.endOffset);t.nativeSelection.addRange(D(r));t.nativeSelection.extend(n.startContainer,n.startOffset);t.refresh()};if(_){H.addRange=function(t,n){if(T&&m&&this.docSelection.type==h){L(this,t)}else{if(n&&E){Q(this,t)}else{var i;if(y){i=this.rangeCount}else{this.removeAllRanges();i=0}this.nativeSelection.addRange(D(t));this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==i+1){if(e.config.checkSelectionRanges){var r=B(this.nativeSelection,this.rangeCount-1);
if(r&&!o.rangesEqual(r,t)){t=new a(r)}}this._ranges[this.rangeCount-1]=t;q(this,t,j(this.nativeSelection));this.isCollapsed=f(this)}else{this.refresh()}}}}}else{H.addRange=function(e,t){if(t&&E){Q(this,e)}else{this.nativeSelection.addRange(D(e));this.refresh()}}}H.setRanges=function(e){if(T&&e.length>1){F(this,e)}else{this.removeAllRanges();for(var t=0,n=e.length;t<n;++t){this.addRange(e[t])}}}}else if(s.isHostMethod(x,"empty")&&s.isHostMethod(C,"select")&&T&&v){H.removeAllRanges=function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var e;if(this.anchorNode){e=r.getDocument(this.anchorNode)}else if(this.docSelection.type==h){var t=this.docSelection.createRange();if(t.length){e=r.getDocument(t.item(0)).body.createTextRange()}}if(e){var n=e.body.createTextRange();n.select();this.docSelection.empty()}}}catch(i){}O(this)};H.addRange=function(e){if(this.docSelection.type==h){L(this,e)}else{a.rangeToTextRange(e).select();this._ranges[0]=e;this.rangeCount=1;this.isCollapsed=this._ranges[0].collapsed;
q(this,e,false)}};H.setRanges=function(e){this.removeAllRanges();var t=e.length;if(t>1){F(this,e)}else if(t){this.addRange(e[0])}}}else{t.fail("No means of selecting a Range or TextRange was found");return false}H.getRangeAt=function(e){if(e<0||e>=this.rangeCount){throw new d("INDEX_SIZE_ERR")}else{return this._ranges[e]}};var V;if(v){V=function(t){var n;if(e.isSelectionValid(t.win)){n=t.docSelection.createRange()}else{n=r.getBody(t.win.document).createTextRange();n.collapse(true)}if(t.docSelection.type==h){k(t)}else if(A(n)){P(t,n)}else{O(t)}}}else if(s.isHostMethod(x,"getRangeAt")&&typeof x.rangeCount=="number"){V=function(t){if(T&&m&&t.docSelection.type==h){k(t)}else{t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount;if(t.rangeCount){for(var n=0,i=t.rangeCount;n<i;++n){t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n))}q(t,t._ranges[t.rangeCount-1],j(t.nativeSelection));t.isCollapsed=f(t)}else{O(t)}}}}else if(b&&typeof x.isCollapsed==n&&typeof C.collapsed==n&&e.features.implementsDomRange){
V=function(e){var t,n=e.nativeSelection;if(n.anchorNode){t=B(n,0);e._ranges=[t];e.rangeCount=1;R(e);e.isCollapsed=f(e)}else{O(e)}}}else{t.fail("No means of obtaining a Range or TextRange from the user's selection was found");return false}H.refresh=function(e){var t=e?this._ranges.slice(0):null;V(this);if(e){var n=t.length;if(n!=this._ranges.length){return false}while(n--){if(!o.rangesEqual(t[n],this._ranges[n])){return false}}return true}};var W=function(e,t){var n=e.getAllRanges(),i=false;e.removeAllRanges();for(var r=0,s=n.length;r<s;++r){if(i||t!==n[r]){e.addRange(n[r])}else{i=true}}if(!e.rangeCount){O(e)}};if(T){H.removeRange=function(e){if(this.docSelection.type==h){var t=this.docSelection.createRange();var n=I(e);var i=r.getDocument(t.item(0));var s=r.getBody(i).createControlRange();var o,a=false;for(var d=0,c=t.length;d<c;++d){o=t.item(d);if(o!==n||a){s.add(t.item(d))}else{a=true}}s.select();k(this)}else{W(this,e)}}}else{H.removeRange=function(e){W(this,e)}}var j;if(!v&&b&&e.features.implementsDomRange){
j=function(e){var t=false;if(e.anchorNode){t=r.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)==1}return t};H.isBackwards=function(){return j(this)}}else{j=H.isBackwards=function(){return false}}H.toString=function(){var e=[];for(var t=0,n=this.rangeCount;t<n;++t){e[t]=""+this._ranges[t]}return e.join("")};function Y(e,t){if(e.anchorNode&&r.getDocument(e.anchorNode)!==r.getDocument(t)){throw new d("WRONG_DOCUMENT_ERR")}}H.collapse=function(t,n){Y(this,t);var i=e.createRange(r.getDocument(t));i.collapseToPoint(t,n);this.removeAllRanges();this.addRange(i);this.isCollapsed=true};H.collapseToStart=function(){if(this.rangeCount){var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)}else{throw new d("INVALID_STATE_ERR")}};H.collapseToEnd=function(){if(this.rangeCount){var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)}else{throw new d("INVALID_STATE_ERR")}};H.selectAllChildren=function(t){Y(this,t);var n=e.createRange(r.getDocument(t));
n.selectNodeContents(t);this.removeAllRanges();this.addRange(n)};H.deleteFromDocument=function(){if(T&&m&&this.docSelection.type==h){var e=this.docSelection.createRange();var t;while(e.length){t=e.item(0);e.remove(t);t.parentNode.removeChild(t)}this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();this.removeAllRanges();for(var i=0,r=n.length;i<r;++i){n[i].deleteContents()}this.addRange(n[r-1])}};H.getAllRanges=function(){return this._ranges.slice(0)};H.setSingleRange=function(e){this.setRanges([e])};H.containsNode=function(e,t){for(var n=0,i=this._ranges.length;n<i;++n){if(this._ranges[n].containsNode(e,t)){return true}}return false};H.toHtml=function(){var e="";if(this.rangeCount){var t=o.getRangeDocument(this._ranges[0]).createElement("div");for(var n=0,i=this._ranges.length;n<i;++n){t.appendChild(this._ranges[n].cloneContents())}e=t.innerHTML}return e};function z(e){var t=[];var n=new c(e.anchorNode,e.anchorOffset);var i=new c(e.focusNode,e.focusOffset);var r=typeof e.getName=="function"?e.getName():"Selection";
if(typeof e.rangeCount!="undefined"){for(var s=0,a=e.rangeCount;s<a;++s){t[s]=o.inspect(e.getRangeAt(s))}}return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}H.getName=function(){return"WrappedSelection"};H.inspect=function(){return z(this)};H.detach=function(){this.win[i]=null;this.win=this.anchorNode=this.focusNode=null};U.inspect=z;e.Selection=U;e.selectionPrototype=H;e.addCreateMissingNativeApiListener(function(t){if(typeof t.getSelection=="undefined"){t.getSelection=function(){return e.getSelection(this)}}t=null})})});define("shared/rangy",["shared/polyfills","gating","third_party/rangy-core"],function t(require,exports,e){var t=require("gating"),n;if(t.use_native_selection){n={getSelection:function(){return window.getSelection()},createRange:function(){return document.createRange()},init:function(){}}}else{require("third_party/rangy-core");n=window.rangy}exports.rangy=n;exports.rangeFromPoint=function(e,t){var i,r,s,o,a;if(document.caretPositionFromPoint){
i=document.caretPositionFromPoint(e,t);s=i.offsetNode;o=i.offset}else if(document.caretRangeFromPoint){r=document.caretRangeFromPoint(e,t);s=r.startContainer;o=r.startOffset}else if(document.elementFromPoint){s=document.elementFromPoint(e,t);o=0}if(s&&o!==undefined){a=n.createRange();a.setStart(s,o);a.setEnd(s,o);a.collapse(true);return a}return null}});define("qtext2/constants",["shared/polyfills"],function n(require,exports,e){exports.CONTENT_TYPES={TEXT:"text/plain",HTML:"text/html",PUBLIC_HTML:"public.html"};exports.FRACTIONS={"⅐":[1,7],"⅑":[1,9],"⅒":[1,10],"⅓":[1,3],"⅔":[2,3],"⅕":[1,5],"⅖":[2,5],"⅗":[3,5],"⅘":[4,5],"⅙":[1,6],"⅚":[5,6],"⅛":[1,8],"⅜":[3,8],"⅝":[5,8],"⅞":[7,8]};exports.ELLIPSIS="…";exports.OPEN_SINGLE_QUOTE="‘";exports.CLOSE_SINGLE_QUOTE="’";exports.OPEN_DOUBLE_QUOTE="“";exports.CLOSE_DOUBLE_QUOTE="”";exports.SINGLE_PRIME="′";exports.DOUBLE_PRIME="″";exports.EN_DASH="–";exports.EM_DASH="—";exports.LEFT_ARROW="←";exports.RIGHT_ARROW="→";exports.WORD_START_REGEX=/\s|[({[]/;
});define("qtext2/container",["shared/polyfills","shared/Class","qtext2/util"],function i(require,exports,e){var t=require("shared/Class").Class,n=require("qtext2/util").Util;var i=t.extend({__init__:function(e){this.kind=e;this.node=n.create("DIV");this.node.className=this.kind;this.children=[]},init:function(){},insertAfter:function(e,t){if(e.parent){e.parent.removeChild(e)}if(t){var n=t.node.nextSibling;this.node.insertBefore(e.node,n);this.children.splice(this.children.indexOf(t)+1,0,e)}else{this.node.appendChild(e.node);this.children.push(e)}e.parent=this},insertBefore:function(e,t){if(e.parent){e.parent.removeChild(e)}if(t){this.node.insertBefore(e.node,t.node);this.children.splice(this.children.indexOf(t),0,e)}else{this.node.appendChild(e.node);this.children.push(e)}e.parent=this},appendChild:function(e){this.insertBefore(e)},appendChildren:function(e){e.forEach(this.appendChild.bind(this))},hasChild:function(e){return this.children.indexOf(e)!==-1},removeChild:function(e){if(!this.hasChild(e)){
return}var t=this.children.indexOf(e);this.children.splice(t,1);n.safeRemoveChild(e.node,this.node)},removeChildren:function(){var e=this.firstChild(),t;while(e){t=e.nextSibling();this.removeChild(e);e=t}},previousSibling:function(){return this.node.previousSibling&&this.Class.get(this.node.previousSibling)},nextSibling:function(){return this.node.nextSibling&&this.Class.get(this.node.nextSibling)},firstChild:function(){if(this.children.length===0){return null}return this.children[0]},lastChild:function(){if(this.children.length===0){return null}return this.children[this.children.length-1]}});i.create=function(e,t){var r;n.assert(!t.__init__,"Do not override __init__");t.__init__=function(){this._super(e);this.init.apply(this,arguments);this.Class=r;r.add(this,this.node)};r=i.extend(t);r.add=function(e,t){n.setData(t,"kind",e.kind);t.qtextContainer=e};r.get=function(e){n.assert(r.is(e));return e.qtextContainer};r.is=function(t){if(!t){return false}return t.nodeType==1&&n.getData(t,"kind")==e;
};return r};exports.Container=i});define("qtext2/position",["shared/polyfills","shared/Class"],function r(require,exports,e){var t=require("shared/Class").Class;var n=t.extend({__init__:function(e,t){this.span=e;this.offset=t},toJSON:function(){var e=this.span.parent;return{spanIdx:e.children.indexOf(this.span),sectionIdx:e.parent.children.indexOf(e),offset:this.offset}},clone:function(){return new n(this.span,this.offset)},atSpanStart:function(){return this.offset===0},atSpanEnd:function(){return this.offset==this.span.getLength()},atSectionStart:function(){var e=this.span.parent;return this.atSpanStart()&&this.span==e.firstChild()},atSectionEnd:function(){var e=this.span.parent;return this.atSpanEnd()&&this.span==e.lastChild()},atDocStart:function(){var e=this.span.parent,t=e.parent;return this.atSectionStart()&&e==t.firstChild()},atDocEnd:function(){var e=this.span.parent,t=e.parent;return this.atSectionEnd()&&e==t.lastChild()},equals:function(e){return e.span===this.span&&e.offset===this.offset;
},charBefore:function(){if(this.atSectionStart()){return null}return this.prevPositionInSection().charAfter()},hasCharBefore:function(){var e=this.charBefore();return!!e&&e.trim().length!==0},charAfter:function(){if(this.atSectionEnd()){return null}var e=this.span,t=this.offset;if(this.atSpanEnd()){e=e.nextSibling();t=0}return e.getText()[t]},hasCharAfter:function(){var e=this.charAfter();return!!e&&e.trim().length!==0},previousWordBoundary:function(e){e=e||/\W/;var t=this.span,i=this.offset-1,r=t.getText();if(this.atDocStart()){return this}if(this.atSectionStart()){return t.previous().last()}while(t){while(i>0){if(r[i-1].match(e)){return new n(t,i)}i--}t=t.previousSibling();if(t){r=t.getText();i=r.length}}return this.span.parent.first()},nextWordBoundary:function(e){e=e||/\W/;var t=this.span,i=this.offset+1,r=t.getText();if(this.atDocEnd()){return this}if(this.atSectionEnd()){return t.next().first()}while(t){while(i<r.length){if(r[i].match(e)){return new n(t,i)}i++}t=t.nextSibling();if(t){
r=t.getText();i=0}}return this.span.parent.last()},relativePositionInSection:function(e){if(e===0){return this}var t=this.span,i=this.offset,r=t.getLength(),s=t.previousSibling(),o=t.nextSibling(),a=e+i;if(0<=a&&a<=r){return new n(t,a)}else if(a<0&&s){return s.last().relativePositionInSection(e+i)}else if(a>r&&o){return o.first().relativePositionInSection(e-(r-i))}else{return null}},prevPositionInSection:function(e){e=e||1;return this.relativePositionInSection(e*-1)},nextPositionInSection:function(e){return this.relativePositionInSection(e||1)}});exports.Position=n});define("qtext2/modifiers",["shared/polyfills"],function s(require,exports,e){exports.allModifiers=function(){return["bold","italic","underline","link","citation","math","code","image","embed","tweet"]};var t=exports.mutuallyExclusiveSet=function(){return["link","citation"]};exports.nonEditableSet=function(){return["image","embed","tweet"]};exports.editableSet=function(){return["bold","italic","underline","link","citation","math","code"];
};var n=exports.restrictedSets=function(){return[["image","embed","tweet"],["math"],["code"]]};var i=exports.canSetModifier=function(e,i){var r=e.parent;if(r&&r.allowedModifiers().indexOf(i)==-1){return false}if(t().indexOf(i)!=-1&&t().some(function(t){return t!=i&&e.hasModifier(t)})){return false}var s=n().some(function(t){if(t.indexOf(i)!=-1&&e.hasDifferentModifier(t)){return true}if(t.indexOf(i)==-1&&e.hasAnyModifier(t)){return true}return false});if(s){return false}return true};exports.canForceModifier=function(e,r){if(i(e,r)){return true}var s=e.parent;if(s&&s.allowedModifiers().indexOf(r)==-1){return false}if(t().indexOf(r)!=-1){return true}return n().some(function(e){return e.indexOf(r)!=-1})}});define("qtext2/span",["shared/polyfills","qtext2/container","qtext2/position","qtext2/constants","qtext2/modifiers","shared/util","qtext2/util","shared/twitter_oembed"],function o(require,exports,e){var t=require("qtext2/container").Container,n=require("qtext2/position").Position,i=require("qtext2/constants").CONTENT_TYPES,r=require("qtext2/modifiers"),s=require("shared/util").extend,o=require("qtext2/util").Util,a=require("shared/twitter_oembed").loadEmbeds;
var d=t.create("span",{init:function(e,t){t=t||{};this.modifiers={};this._content=this.createContentNode();this.node.appendChild(this._content);this._image=null;if(e){this.setText(e)}else{this.setPlaceholder()}for(var n in t){this.setModifier(n,t[n],true)}},createContentNode:function(){var e=o.create("div");e.className="content";e.qtextSpanContent=true;return e},merge:function(e){if(!this.isEditable()||!e.isEditable()){return}if(!this.hasSameModifiers(e)){return}this.setText(this.getText()+e.getText());e.parent.removeChild(e);return this},hasSameModifiers:function(e){var t=this.modifiers,n=e.modifiers,i=Object.getOwnPropertyNames(t),r=Object.getOwnPropertyNames(n);if(i.length!=r.length){return false}return i.every(function(e){if(e=="link"&&n.link){var i=t.link.url;if(i&&i.substr(-1)!="/"){i+="/"}var r=n.link.url;if(r&&r.substr(-1)!="/"){r+="/"}return i==r}return t[e]==n[e]})},toJSON:function(e,t){return{modifiers:s({},this.modifiers),text:this.getText().slice(e,t)}},previous:function(){
return this.previousSibling()||this.parent.previousSibling()&&this.parent.previousSibling().lastChild()},next:function(){return this.nextSibling()||this.parent.nextSibling()&&this.parent.nextSibling().firstChild()},first:function(){return new n(this,0)},last:function(){return new n(this,this.getLength())},updateModifiers:function(e,t){var n=Object.keys(e),i,r;for(r=0;r<n.length;r++){i=n[r];this.setModifier(i,e[i],t)}this._updateClass()},setModifier:function(e,t,n){if(r.canSetModifier(this,e)){this._setModifier(e,t);return}if(!n||!r.canForceModifier(this,e)){return}var i=this.modifiers;this.modifiers={};this._setModifier(e,t);var s=this;Object.keys(i).forEach(function(e){s.setModifier(e,i[e])})},_setModifier:function(e,t){this.modifiers[e]=t||true;if(e=="image"){if(this._image===null){this._image=o.create("img")}this.setText("");this._content.appendChild(this._image);this._image.src=t}if(e=="tweet"){var n=t.root,i=t.shouldLoad;this._content.appendChild(n);if(i){a()}}if(e=="underline"){this._content.style.textDecoration="underline";
}this._updateClass()},isEditable:function(){var e=this;return!r.nonEditableSet().some(function(t){return e.hasModifier(t)})},hasAnyModifier:function(e){return Object.keys(this.modifiers).some(function(t){return e.indexOf(t)!=-1})},hasDifferentModifier:function(e){return Object.keys(this.modifiers).some(function(t){return e.indexOf(t)==-1})},removeAllModifiers:function(){this.modifiers={};this._updateClass()},removeModifier:function(e){delete this.modifiers[e];this._updateClass()},getModifier:function(e){return this.modifiers[e]},getModifiers:function(){return s({},this.modifiers)},hasModifier:function(e){return e in this.modifiers},_updateClass:function(){this.node.className="span";for(var e in this.modifiers){if(this.modifiers.hasOwnProperty(e)&&this.modifiers[e]){this.node.className+=" "+e}}},isEmpty:function(){if(!this.isEditable()){return false}return this.node.textContent===""||this.node.innerHTML===""||this.node.innerHTML=="<br>"},getText:function(){return this._content.textContent;
},setText:function(e){this._content.textContent=e},insertText:function(e,t){var n=this.getText();this.setText(n.slice(0,t)+e+n.slice(t))},deleteText:function(e,t){this.setText(this.getText().slice(0,e)+this.getText().slice(t))},getLength:function(){if(!this.isEditable()){return 1}return this.getText().length},isOnlyWhiteSpace:function(){if(!this.isEditable()){return false}if(this.hasModifier("citation")){return false}return this.getText().trim().length==0},getFocusNode:function(){if(o.isTextNode(this._content.firstChild)){return this._content.firstChild}return this._content},setPlaceholder:function(){this._content.innerHTML="<br/>";for(var e in this.modifiers){this.removeModifier(e)}},shouldAvoidSplitting:function(){return this.hasModifier("link")||this.hasModifier("code")||this.hasModifier("math")},split:function(e,t){var n;if(!t&&this.shouldAvoidSplitting()){return this}if(this.isEmpty()){n=new d(null,this.modifiers)}else if(e===0){n=new d(this.getText(),this.modifiers);this.setPlaceholder();
}else{n=new d(this.getText().slice(e),this.modifiers);this.setText(this.getText().slice(0,e))}this.parent.insertBefore(n,this.nextSibling());return n},_toText:function(){var e,t;e=this.getText();if(this.hasModifier("math")){e="$"+e+"$"}if(this.hasModifier("italic")){e="*"+e+"*"}if(this.hasModifier("bold")){e="**"+e+"**"}if(this.hasModifier("underline")){e="_"+e+"_"}if(this.hasModifier("link")){t=this.getModifier("link");e+=" ("+t.url+")"}return e},_toHTML:function(){var e,t;if(this.hasModifier("image")){return'<img src="'+this.getModifier("image")+'"/>'}e=this.getText();e=o.escapeHTML(e);e=e.replace(/\n/gi,"<br>");if(this.hasModifier("italic")){e="<i>"+e+"</i>"}if(this.hasModifier("bold")){e="<b>"+e+"</b>"}if(this.hasModifier("underline")){e="<u>"+e+"</u>"}if(this.hasModifier("link")){t=this.getModifier("link");e='<a href="'+t.url+'">'+e+"</a>"}if(this.hasModifier("code")){e="<code>"+e+"</code>"}else if(this.hasModifier("math")){e="<math>"+e+"</math>"}return e},toContent:function(e){if(e==i.TEXT){
return this._toText()}else if(e==i.HTML){return this._toHTML()}}});exports.Span=d});define("qtext2/undo",["shared/polyfills","shared/Class"],function a(require,exports,e){var t=require("shared/Class").Class;var n=t.extend({__init__:function(e){this.current={state:e,next:null,prev:null}},state:function(){return this.current.state},add:function(e){if(this.current.next){this.current.next.prev=null}this.current.next={state:e,prev:this.current,next:null};this.current=this.current.next},undo:function(){if(this.current.prev){this.current=this.current.prev}},redo:function(){if(this.current.next){this.current=this.current.next}},canUndo:function(){return!!this.current.prev},canRedo:function(){return!!this.current.next}});exports.UndoManager=n});define("qtext2/sections/plain",["shared/polyfills","qtext2/section"],function d(require,exports,e){var t=require("qtext2/section").Section;var n=t.extend({init:function(e,t,n){this._super("plain",e,t,n)},htmlIndentPrefix:"",htmlIndentSuffix:"",htmlPrefix:"<p>",
htmlSuffix:"</p>"});exports.PlainSection=n});define("qtext2/sections/code",["shared/polyfills","qtext2/section"],function c(require,exports,e){var t=require("qtext2/section"),n=t.Section;var i=n.extend({init:function(e,t,n){this._super("code",e,t,n);this.children.forEach(function(e){e.removeAllModifiers()})},allowedModifiers:function(){return[]},htmlIndentPrefix:"",htmlIndentSuffix:"",htmlPrefix:"<pre>",htmlSuffix:"</pre>"});exports.CodeSection=i});define("qtext2/sections/image",["shared/polyfills","qtext2/section","qtext2/span","qtext2/util"],function l(require,exports,e){var t=require("qtext2/section"),n=t.Section,i=require("qtext2/span").Span,r=require("qtext2/util").Util;var s=n.extend({init:function(e,t,n){r.assert(e.length==1,"ImageSections should have exactly one child:",e);r.assert(e[0].hasModifier("image"),"missing image modifier on image span");this._super("image",e,t,n)},allowedModifiers:function(){return["image"]},htmlIndentPrefix:"",htmlIndentSuffix:"",htmlPrefix:"<p>",htmlSuffix:"</p>"
});s.fromURL=function(e){return new s([new i("",{image:e})])};exports.ImageSection=s});define("qtext2/sections/horizontal_rule",["shared/polyfills","qtext2/section","qtext2/span"],function f(require,exports,e){var t=require("qtext2/section").Section,n=require("qtext2/span").Span;var i=t.extend({init:function(){var e=[new n("",{image:"/static/images/hr_img_3.png"})];this._super("horizontal-rule",e,0,false)},allowedModifiers:function(){return["image"]},getChildrenContents:function(){return""},_getHTMLPrefix:function(){return"<hr>"},_getHTMLSuffix:function(){return"</hr>"}});exports.HorizontalRuleSection=i});define("qtext2/sections/lists",["shared/polyfills","qtext2/section"],function h(require,exports,e){var t=require("qtext2/section"),n=t.Section;var i=exports.isListSection=function(e){return e instanceof r};var r=n.extend({allowsMultipleSoftReturns:function(){return true},maxIndent:function(){if(this.parent){var e=this.previousSibling();if(!e||!i(e)){return 0}else{return Math.min(2,e.getIndent()+1);
}}return 2},htmlPrefix:"<li>",htmlSuffix:"</li>"});exports.UnorderedListSection=r.extend({init:function(e,t,n){this._super("unordered-list",e,t,n)},_getTextPrefix:function(e){return this._super(e)+"* "},htmlIndentPrefix:"<ul>",htmlIndentSuffix:"</ul>"});exports.OrderedListSection=r.extend({init:function(e,t,n){this._super("ordered-list",e,t,n)},_getTextPrefix:function(e){var t=this._super(e),n,i=this.getIndent(),r=e.indexOf(this)-1,s=1;while(r>=0){n=e[r];if(i>n.getIndent()||!(n instanceof this.constructor)){break}if(i==n.getIndent()){s++}r--}return t+s+". "},htmlIndentPrefix:"<ol>",htmlIndentSuffix:"</ol>"})});define("shared/embedly",["shared/polyfills","interface/rpc"],function u(require,exports,e){var t=require("interface/rpc").rpc;function n(e,t){i(e,function(e){if(e){t(e)}else{t(null)}})}function i(e,n){t("/embedly_/get_oembedly_json_POST").kwargs({url:e}).success(function(e){if("error"in e){n(null)}else{n(e)}}).error(function(){n(null)}).send()}exports.getOEmbedlyData=n});define("qtext2/sections/embed",["shared/polyfills","qtext2/span","qtext2/section","qtext2/modifiers","qtext2/sections/plain","qtext2/util","shared/errors","qtext2/constants","shared/twitter_oembed","shared/embedly","gating"],function p(require,exports,e){
var t=require("qtext2/span").Span,n=require("qtext2/section").Section,i=require("qtext2/modifiers"),r=require("qtext2/sections/plain").PlainSection,s=require("qtext2/util").Util,o=require("shared/errors"),a=require("qtext2/constants").CONTENT_TYPES,d=require("shared/twitter_oembed").getTweetData;var c=n.extend({init:function(e,t,n){s.assert(e.length==1,"EmbedSections should have exactly one child:",e);s.assert(e[0].hasModifier("embed"),"missing embed modifier on embed span");this._super(this.type,e,t,n);var i=e[0].getModifier("embed").url;this._setEmbed(i)},toContent:function(e,n){var i=this.children[0].getModifier("embed").url;if(e==a.TEXT){return i}else{var r=new t(i,{link:{type:"url",url:i}});return r.toContent(e)}},toJSON:function(){var e={type:this.getType(),indent:this.getIndent(),quoted:this.isQuoted(),spans:[]};this.children.forEach(function(t){var n=t.toJSON();for(var i in n.modifiers){if(i!=="embed"){delete n.modifiers[i]}}e.spans.push(n)});return e},_setEmbed:function(){return;
},allowedModifiers:function(){return i.nonEditableSet()},_onEmbedSectionCallbackError:function(){var e=this.children[0].getModifier("embed").url;this.children[0].removeModifier("embed");this.children[0].setText(e);this.children[0].setModifier("link",{type:"url",url:e});this.changeType(r)}});c.getValidRegex=function(e){var t=[];e._VALID_REGEXES.forEach(function(e){t.push("(?:"+e.source+")")});var n=t.join("|");return new RegExp(n)};c.fromOtherSection=function(e){var n=null;if(!e.isEditable()){return null}p.some(function(i){var r=g()[i];var o=true,a="",d=0;var l=c.getValidRegex(r);e.children.forEach(function(e){if(e.hasModifier("link")){var t=e.getModifier("link").url;if(t&&t.match(l)){d+=1;a=e.getModifier("link").url}else{o=false}}else{var n=e.getText();s.splitByRegex(n,l).forEach(function(e){if(e.match){d+=1;a=e.text}else{if(!e.text.match(/^ *$/)){o=false}}})}});if(d==1&&o){n=new r([new t("",{embed:{url:a}})]);return true}return false});return n};var l=c.extend({_onOEmbedCallbackSuccess:function(e,t,n,i){
var r=this.children[0].getModifier("embed");if(n!==undefined&&n!==null){s.assert(i===undefined||i===null,"If iframe_html is supplied, iframe_url has to be null / undefined.");var o=s.create("div");o.innerHTML=n;i=o.children[0].src}s.assert(i!==null,"For OEmbedSection, we have to have the iframe URL.");r.thumbnail_url=t;r.content_type=e;r.iframe={url:i};this.children[0].setModifier("embed",r);this.children[0].setModifier("image",t)}});var f=l.extend({_setEmbed:function(e){var t=this;var n=this.children[0].getModifier("embed");if(n.thumbnail_url&&n.content_type&&n.iframe&&n.iframe.url){t._onOEmbedCallbackSuccess(n.content_type,n.thumbnail_url,null,n.iframe.url)}else{require("shared/embedly").getOEmbedlyData(e,function(e){if(e){t._onOEmbedCallbackSuccess(e.type,e.thumbnail_url,e.html)}else{t._onEmbedSectionCallbackError()}})}},type:"oembedly"});f._VALID_REGEXES=[/http:\/\/www.vimeo.com\/groups\/*\/videos\/.*/,/http:\/\/www.vimeo.com\/.*/,/https:\/\/www.vimeo.com\/.*/,/http:\/\/vimeo.com\/groups\/.*\/videos\/.*/,/http:\/\/vimeo.com\/.*/,/https:\/\/vimeo.com\/.*/,/http:\/\/vimeo.com\/m\/#\/.*/,/http:\/\/player.vimeo.com\/.*/,/https:\/\/player.vimeo.com\/.*/,/http:\/\/www.hulu.com\/watch.*/,/http:\/\/www.hulu.com\/w\/.*/,/http:\/\/www.hulu.com\/embed\/.*/,/http:\/\/hulu.com\/watch.*/,/http:\/\/hulu.com\/w\/.*/,/http:\/\/hulu.tv\/.*/,/http:\/\/www.ustream.tv\/recorded\/.*/,/http:\/\/www.ustream.tv\/channel\/.*/,/http:\/\/www.ustream.tv\/.*/,/http:\/\/ustre.am\/.*/,/http:\/\/link.brightcove.com\/services\/player\/bcpid.*/,/http:\/\/bcove.me\/.*/,/http:\/\/www.vevo.com\/watch\/.*/,/http:\/\/www.vevo.com\/video\/.*/,/http:\/\/video.google.com\/videoplay\?.*/,/http:\/\/.*.dailymotion.com\/video\/.*/,/http:\/\/.*.dailymotion.com\/.*\/video\/.*/,/http:\/\/khanacademy.org\/*/,/http:\/\/www.khanacademy.org\/*/,/https:\/\/khanacademy.org\/*/,/https:\/\/www.khanacademy.org\/*/,/http:\/\/www.ted.com\/talks\/.*.html.*/,/http:\/\/www.ted.com\/talks\/lang\/.*\/.*.html*/,/http:\/\/www.ted.com\/index.php\/talks\/.*.html.*/,/http:\/\/www.ted.com\/index.php\/talks\/lang\/.*\/.*.html/,/http:\/\/www.ted.com\/talks\/.*/];
var h=c.extend({_setEmbed:function(e){var t,n;n=c.getValidRegex(h).exec(e);if(n){t=n[1]}else{o.report(new Error("VideoSection: url did not match regex: "+e));t=""}this.children[0].setModifier("image","https://img.youtube.com/vi/"+t+"/0.jpg")},type:"video",htmlIndentPrefix:"",htmlIndentSuffix:"",htmlPrefix:"<p>",htmlSuffix:"</p>"});h._VALID_REGEXES=[/(?:https?:\/{2})?(?:w{3}\.)?(?:youtube\.com\/watch.+v=|youtu.be\/|youtube.com\/embed\/)([^\s?]+)(\?[^\s]+)?/];var u=c.extend({_onTweetCallbackSuccess:function(e,t){var n={root:e,shouldLoad:t};this.children[0].setModifier("tweet",n)},_setEmbed:function(e){var t=this;d(e,function(e,n){if(e){t._onTweetCallbackSuccess(e,n)}else{t._onEmbedSectionCallbackError()}})},type:"tweet",htmlIndentPrefix:"",htmlIndentSuffix:"",htmlPrefix:"<p>",htmlSuffix:"</p>"});u._VALID_REGEXES=[/https:\/\/twitter.com\/.*\/status\/.*/];var p=["oembedly","video"];if(require("gating").render_tweets_as_embeds){p.push("tweet")}var g=function(){var e={};e.video=h;e.oembedly=f;
if(require("gating").render_tweets_as_embeds){e.tweet=u}return e};exports.EmbedSection=c;exports.OEmbedlySection=f;exports.VideoSection=h;exports.TweetSection=u;exports.EMBED_SECTION_TYPES=p});define("qtext2/section",["shared/polyfills","qtext2/container","qtext2/constants","qtext2/modifiers","qtext2/span","qtext2/util","qtext2/sections/plain","qtext2/sections/code","qtext2/sections/image","qtext2/sections/horizontal_rule","qtext2/sections/lists","qtext2/sections/embed","gating"],function g(require,exports,e){var t=require("qtext2/container").Container,n=require("qtext2/constants").CONTENT_TYPES,i=require("qtext2/modifiers"),r=require("qtext2/span").Span,s=require("qtext2/util").Util;var o=function(){var e={};e.plain=require("qtext2/sections/plain").PlainSection;e.code=require("qtext2/sections/code").CodeSection;e.image=require("qtext2/sections/image").ImageSection;var t=require("qtext2/sections/horizontal_rule");e["horizontal-rule"]=t.HorizontalRuleSection;var n=require("qtext2/sections/lists");
e["ordered-list"]=n.OrderedListSection;e["unordered-list"]=n.UnorderedListSection;var i=require("qtext2/sections/embed");e.embed=i.EmbedSection;e.video=i.VideoSection;e.oembedly=i.OEmbedlySection;if(require("gating").render_tweets_as_embeds){e.tweet=i.TweetSection}return e};var a=t.create("section",{init:function(e,t,n,i){var o=this;t=t&&t.length!==0?t:[new r];t.slice().forEach(function(e){o.appendChild(e)});s.setData(this.node,"type",e);this.setIndent(n||0);this.setQuoted(i)},getType:function(){return s.getData(this.node,"type")},getLength:function(){var e=0;this.children.forEach(function(t){e+=t.getLength()});return e},getIndent:function(){return parseInt(s.getData(this.node,"indent"))},setIndent:function(e){e=Math.min(this.maxIndent(),Math.max(0,e));s.setData(this.node,"indent",e);return this.maxIndent()!==0},setQuoted:function(e){if(e){s.setData(this.node,"quoted","true")}else{s.removeData(this.node,"quoted")}},isQuoted:function(){return!!s.getData(this.node,"quoted")},isEditable:function(){
return!this.children.some(function(e){return!e.isEditable()})},allowsMultipleSoftReturns:function(){return false},allowedModifiers:function(){return i.editableSet()},toContent:function(e,t){var n=[];n.push(this.getContentPrefix(e,t));n.push(this.getChildrenContents(e));n.push(this.getContentSuffix(e,t));n=n.join("");return n},getChildrenContents:function(e){return this.children.map(function(t){return t.toContent(e)}).join("")},toJSON:function(){var e={type:this.getType(),indent:this.getIndent(),quoted:this.isQuoted(),spans:[]};this.children.forEach(function(t){e.spans.push(t.toJSON())});return e},first:function(){return this.firstChild().first()},last:function(){return this.lastChild().last()},getText:function(){var e="";this.children.forEach(function(t){e+=t.getText()});return e},deleteText:function(e,t){if(e.span==t.span){e.span.deleteText(e.offset,t.offset)}else{e.span.deleteText(e.offset,e.span.getLength());while(e.span.nextSibling()!=t.span){this.removeChild(e.span.nextSibling())}if(t.span){
t.span.deleteText(0,t.offset);if(t.span.isEmpty()){this.removeChild(t.span)}}}},isEmpty:function(){return this.children.length==1&&this.children[0].isEmpty()},isOnlyWhiteSpace:function(){return this.children.every(function(e){return e.isOnlyWhiteSpace()})},_createSplitSection:function(e){return new this.constructor(e,this.getIndent(),this.isQuoted())},split:function(e){var t,n,i,s,o=e.span,a=e.offset;if(a===0){if(o==this.firstChild()){this.insertBefore(new r,o)}s=o}else if(a===o.getLength()){if(o==this.lastChild()){s=new r;this.appendChild(s)}else{s=o.nextSibling()}}else{s=o.split(a,true)}t=this.children.indexOf(s)+1;i=this.children.slice(t);i.unshift(s);n=this._createSplitSection(i);this.parent.insertBefore(n,this.nextSibling());return s.first()},merge:function(e){var t,n,i;if(!e.isEditable()){if(this.isEmpty()){if(this.parent){this.parent.removeChild(this)}}t=e.first()}else if(e.isEmpty()){if(e.parent){e.parent.removeChild(e)}t=this.last()}else if(!this.isEditable()){if(this.parent){this.parent.removeChild(this);
}t=e.first()}else{if(this.isEmpty()){this.removeChild(this.firstChild());this.setIndent(e.getIndent());this.setQuoted(e.isQuoted());t=e.first()}else{t=this.last()}while(e.children.length){this.appendChild(e.firstChild())}n=this.firstChild();while(n){i=n.nextSibling();if(i&&n.hasSameModifiers(i)){n=n.merge(i)}else{n=i}}if(e.parent){e.parent.removeChild(e)}}return t},changeType:function(e){var t=new e(this.children,this.getIndent(),this.isQuoted());if(this.parent){this.parent.insertBefore(t,this);this.parent.removeChild(this)}return t},getContentPrefix:function(e,t){if(e==n.TEXT){return this._getTextPrefix(t)}else if(e==n.HTML){return this._getHTMLPrefix(t)}},getContentSuffix:function(e,t){if(e==n.TEXT){return this._getTextSuffix(t)}else if(e==n.HTML){return this._getHTMLSuffix(t)}},_getTextPrefix:function(){var e,t="";for(e=0;e<this.getIndent()*4;e++){t+=" "}if(this.isQuoted()){t+=">"}return t},_getTextSuffix:function(){return"\n"},_getHTMLPrefix:function(e){var t="",n=e.indexOf(this),i=this.getIndent(),r=-1,s;
if(n>0){s=e[n-1];if(s instanceof this.constructor){r=s.getIndent()}if(this.isQuoted()&&!s.isQuoted()){t+="<blockquote>"}}else if(this.isQuoted()){t+="<blockquote>"}while(i>r){t+=this.htmlIndentPrefix;i--}return t+this.htmlPrefix},_getHTMLSuffix:function(e){var t=this.htmlSuffix,n=e.indexOf(this),i=this.getIndent(),r=-1,s;if(n<e.length-1){s=e[n+1];if(s instanceof this.constructor){r=s.getIndent()}}while(i>r){i--;t+=this.htmlIndentSuffix}if(this.isQuoted()&&(!s||!s.isQuoted())){t+="</blockquote>"}return t},maxIndent:function(){return 0}});a.fromJSON=function(e){var t=[],n=o()[e.type];e.spans.forEach(function(e){t.push(new r(e.text,e.modifiers))});return new n(t,e.indent,e.quoted)};exports.Section=a});define("qtext2/formatting_state",["shared/polyfills","shared/Class","qtext2/util"],function m(require,exports,e){var t=require("shared/Class").Class,n=require("qtext2/util").Util;exports.FormattingState=t.extend({__init__:function(e){this._modifiers={};this.update(e)},is:function(e){return e in this._modifiers;
},update:function(e){this.updatePosition(e);this._modifiers=e.start.span.getModifiers();if(!this._isLinked()){delete this._modifiers.link;delete this._modifiers.citation}},updatePosition:function(e){this.caret=e;this.position=e.start.clone();this.spanLength=e.start.span.getLength()},_isLinked:function(){var e=this.caret.start.span;if(!(e.hasModifier("link")||e.hasModifier("citation"))){return false}if(this.caret.isCollapsed()){return!this.caret.start.atSpanStart()&&!this.caret.start.atSpanEnd()}return e==this.caret.end.span},toggleModifier:function(e,t){if(t in this._modifiers){delete this._modifiers[t]}else if(t!="link"&&t!="citation"){this._modifiers[t]=true}this.position=e.start.clone()},hasChanged:function(e){return!n.jsonEqual(this._modifiers,e.start.span.getModifiers())&&this.spanLength!=e.start.span.getLength()},apply:function(e){var t=!n.jsonEqual(e.modifiers,this._modifiers);e.removeAllModifiers();e.updateModifiers(this._modifiers);return t}})});define("qtext2/selection",["shared/polyfills","shared/Class"],function v(require,exports,e){
var t=require("shared/Class").Class;var n=exports.Selection=t.extend({__init__:function(e,t,n){this.start=e;this.end=t;this.doc=n},toJSON:function(){return{start:this.start.toJSON(),end:this.end.toJSON()}},equals:function(e){return this.start.equals(e.start)&&this.end.equals(e.end)},getStartNode:function(){return this.start.span.getFocusNode()},getEndNode:function(){return this.end.span.getFocusNode()},moveStart:function(e){this.start.span=e.span;this.start.offset=e.offset},moveEnd:function(e){this.end.span=e.span;this.end.offset=e.offset},isCollapsed:function(){return this.start.equals(this.end)},charBefore:function(){return this.start.charBefore()},hasCharBefore:function(){return this.start.hasCharBefore()},previousTextUntil:function(e){var t=this.start.span,n=this.start.offset,i="";while(t&&t!=e.span){i=t.getText().substring(0,n)+i;t=t.previousSibling();if(t){n=t.getLength()}}if(t){i=t.getText().substring(e.offset,n)+i}return i},hasCharAfter:function(){return this.start.hasCharAfter();
},charAfter:function(){return this.end.charAfter()},charPosition:function(){var e=this.start.offset;var t=this.start.span.previousSibling();while(t){e+=t.getLength();t=t.previousSibling()}var n=this.start.span.parent.previousSibling();while(n){e+=n.getLength()+1;n=n.previousSibling()}return e},containsEntireSection:function(e){var t=this.start,n=this.end,i;i=t.span.parent;while(i&&i.previousSibling()!=n.span.parent){if(e==i&&(t.span.parent!=e||t.atSectionStart())&&(n.span.parent!=e||n.atSectionEnd())){return true}i=i.nextSibling()}return false},getCoveringSpans:function(){var e=this.start.span,t=[];while(e&&e!=this.end.span){t.push(e);e=e.next()}t.push(e);return t},getText:function(){var e="";if(this.start.span.parent!=this.end.span.parent){var t=this.start.span.parent,i=this.end.span.parent,r=new n(this.start,t.last()),s=new n(i.first(),this.end);e+=r.getText();for(var o=t.nextSibling();o&&o!=i;o=o.nextSibling()){e+=o.getText()}e+=s.getText();return e}var a=this.start.span,d=this.start.offset;
while(a&&a!=this.end.span){e+=a.getText().substring(d,a.getLength());d=0;a=a.nextSibling()}if(a){e+=a.getText().substring(d,this.end.offset)}return e}})});define("qtext2/caret",["shared/polyfills","shared/Class","interface/jquery","qtext2/util","shared/rangy","settings","qtext2/span","qtext2/section","qtext2/base","qtext2/position","qtext2/selection","shared/client"],function x(require,exports,e){var t=require("shared/Class").Class,$=require("interface/jquery")._jQuery,n=require("qtext2/util").Util,i=require("shared/rangy").rangy,r=require("settings"),s=r.pageIsMobile,o=require("qtext2/span").Span,a=require("qtext2/section").Section,d=require("qtext2/base"),c=require("qtext2/position").Position,l=require("qtext2/selection").Selection,f=require("shared/client"),h;if(s){h=require("mobile_app2/messages")}exports.Caret=t.extend({__init__:function(e,t,n){this.selection=new l(e,t,n);this.doc=n;var i=this;Object.defineProperty(i,"start",{get:function(){return i.selection.start},set:function(e){
i.selection=new l(e,i.end)}});Object.defineProperty(i,"end",{get:function(){return i.selection.end},set:function(e){i.selection=new l(i.start,e)}})},toJSON:function(){return this.selection.toJSON()},getStartNode:function(){return this.selection.getStartNode()},getEndNode:function(){return this.selection.getEndNode()},moveStart:function(e){return this.selection.moveStart(e)},moveEnd:function(e){return this.selection.moveEnd(e)},move:function(e,t,n){t=t||e;var i=true;if(this.start.equals(e)&&this.end.equals(t)){i=false}this.start.span=e.span;this.start.offset=e.offset;this.end.span=t.span;this.end.offset=t.offset;this._apply(n);return i},isCollapsed:function(){return this.selection.isCollapsed()},charBefore:function(){return this.selection.charBefore()},hasCharBefore:function(){return this.selection.hasCharBefore()},previousTextUntil:function(e){return this.selection.previousTextUntil(e)},charAfter:function(){return this.selection.charAfter()},charPosition:function(){return this.selection.charPosition();
},hasCharAfter:function(){return this.selection.hasCharAfter()},updateAndroidCaretPosition:function(e){e=e||0;if(s&&f.isAndroidApp()){h.send("setCaretPos",{selectionStart:this.charPosition()+e})}},update:function(e){var t=i.getSelection(),n,r,s;if(!t.anchorNode){return false}if(t.isCollapsed){n=r=this._fromNode(t.anchorNode,t.anchorOffset)}else{s=t.getRangeAt(0);n=this._fromNode(s.startContainer,s.startOffset);r=this._fromNode(s.endContainer,s.endOffset)}if(!(n&&r)){return false}return this.move(n,r,e)},_fromNode:function(e,t){var n,i,l,h;if(!this.doc.contains(e)){if(s&&f.isAndroidApp()&&r.osVersion<4.4){var u=e;while(u){if(d.Doc.is(u)){break}u=u.parentNode}if(!u){return null}}else{return null}}if(d.Doc.is(e)){h=d.Doc.get(e);if(t===0){i=h.firstChild().firstChild();l=0}else{i=h.lastChild().lastChild();l=i.getLength()}}else if(a.is(e)){n=a.get(e);if(t===0){i=n.firstChild();l=0}else{i=n.lastChild();l=i.getLength()}}else if(o.is(e.parentNode)&&(t===1||t===0)){i=o.get(e.parentNode);l=t===0?0:i.getLength();
}else{while(e&&!o.is(e)){e=e.parentNode}if(!e){return null}i=o.get(e);l=t}return new c(i,l)},_apply:function(e){var t=i.getSelection(),n=this.getStartNode(),r,s;if(this.isCollapsed()){if(!e&&t.isCollapsed&&n==t.anchorNode&&this.start.offset==t.anchorOffset){return}s=i.createRange();s.setStart(n,this.start.offset);s.setEnd(n,this.start.offset);s.collapse(true);t.removeAllRanges();t.addRange(s)}else{r=this.end.span.getFocusNode();if(!t.isCollapsed){s=t.getRangeAt(0);if(!e&&n==s.startContainer&&this.start.offset==s.startOffset&&r==s.endContainer&&this.end.offset==s.endOffset){return}}else{s=i.createRange()}s.setStart(n,this.start.offset);s.setEnd(r,this.end.offset);t.removeAllRanges();t.addRange(s)}return},getAbsolutePosition:function(){var e=window.getSelection(),t=n.firstScrollingParent(this.doc.node),r=document.body.parentElement,s=e.rangeCount>0&&e.getRangeAt(0),o=s?s.getClientRects():[];if(o.length>0){var a={top:o[0].top,left:o[0].left};a.top+=t.scrollTop||r.scrollTop;a.left+=t.scrollLeft||r.scrollLeft;
return a}var d=i.getSelection().anchorNode;if(n.isTextNode(d)){d=this.start.span.parent.node}if($(d).children().first().is("img")){return $(d).children().first().offset()}return n.getContainerOffset(d)},scrollIntoViewIfNeeded:function(){if(!this.isCollapsed()){return}if(!i.getSelection().anchorNode){return}var e=this.getAbsolutePosition(),t=n.firstScrollingParent(this.doc.node),r=document.body.parentElement,o=t.scrollTop||r.scrollTop,a=o+window.innerHeight,d,c,l=30;if(!s){a-=50}if(!e){return}d=e.top;c=d+l;setTimeout(function(){if(d<o){t.scrollTop+=d-o;r.scrollTop+=d-o}else if(c>a){t.scrollTop+=c-a;r.scrollTop+=c-a}},0)},containsEntireSection:function(e){return this.selection.containsEntireSection(e)},mergeAdjacentSpans:function(){if(!this.isCollapsed()){return}var e=this.start.span,t=e.nextSibling(),i=e.previousSibling(),r=this.start.offset;if(t&&n.jsonEqual(e.modifiers,t.modifiers)){e.setText(e.getText()+t.getText());t.parent.removeChild(t);this.move(new c(e,r))}if(i&&n.jsonEqual(e.modifiers,i.modifiers)){
r+=i.getLength();e.setText(i.getText()+e.getText());i.parent.removeChild(i);this.move(new c(e,r))}},getCoveringSpans:function(){return this.selection.getCoveringSpans()}})});define("third_party/mutation-summary",["shared/polyfills"],function C(require,exports,e){var t=this.__extends||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n];function i(){this.constructor=e}i.prototype=t.prototype;e.prototype=new i};var n;if(typeof WebKitMutationObserver!=="undefined")n=WebKitMutationObserver;else n=MutationObserver;if(n===undefined){console.error("DOM Mutation Observers are required.");console.error("https://developer.mozilla.org/en-US/docs/DOM/MutationObserver");throw Error("DOM Mutation Observers are required")}var i=function(){function e(){this.nodes=[];this.values=[]}e.prototype.isIndex=function(e){return+e===e>>>0};e.prototype.nodeId=function(t){var n=t[e.ID_PROP];if(!n)n=t[e.ID_PROP]=e.nextId_++;return n};e.prototype.set=function(e,t){var n=this.nodeId(e);this.nodes[n]=e;this.values[n]=t;
};e.prototype.get=function(e){var t=this.nodeId(e);return this.values[t]};e.prototype.has=function(e){return this.nodeId(e)in this.nodes};e.prototype["delete"]=function(e){var t=this.nodeId(e);delete this.nodes[t];this.values[t]=undefined};e.prototype.keys=function(){var e=[];for(var t in this.nodes){if(!this.isIndex(t))continue;e.push(this.nodes[t])}return e};e.ID_PROP="__mutation_summary_node_map_id__";e.nextId_=1;return e}();var r;(function(e){e[e["STAYED_OUT"]=0]="STAYED_OUT";e[e["ENTERED"]=1]="ENTERED";e[e["STAYED_IN"]=2]="STAYED_IN";e[e["REPARENTED"]=3]="REPARENTED";e[e["REORDERED"]=4]="REORDERED";e[e["EXITED"]=5]="EXITED"})(r||(r={}));function s(e){return e===r.ENTERED||e===r.EXITED}var o=function(){function e(e,t,n,i,r,s,o,a){if(t===void 0){t=false}if(n===void 0){n=false}if(i===void 0){i=false}if(r===void 0){r=null}if(s===void 0){s=false}if(o===void 0){o=null}if(a===void 0){a=null}this.node=e;this.childList=t;this.attributes=n;this.characterData=i;this.oldParentNode=r;this.added=s;
this.attributeOldValues=o;this.characterDataOldValue=a;this.isCaseInsensitive=this.node.nodeType===window.Node.ELEMENT_NODE&&this.node instanceof window.HTMLElement&&this.node.ownerDocument instanceof window.HTMLDocument}e.prototype.getAttributeOldValue=function(e){if(!this.attributeOldValues)return undefined;if(this.isCaseInsensitive)e=e.toLowerCase();return this.attributeOldValues[e]};e.prototype.getAttributeNamesMutated=function(){var e=[];if(!this.attributeOldValues)return e;for(var t in this.attributeOldValues){e.push(t)}return e};e.prototype.attributeMutated=function(e,t){this.attributes=true;this.attributeOldValues=this.attributeOldValues||{};if(e in this.attributeOldValues)return;this.attributeOldValues[e]=t};e.prototype.characterDataMutated=function(e){if(this.characterData)return;this.characterData=true;this.characterDataOldValue=e};e.prototype.removedFromParent=function(e){this.childList=true;if(this.added||this.oldParentNode)this.added=false;else this.oldParentNode=e};e.prototype.insertedIntoParent=function(){
this.childList=true;this.added=true};e.prototype.getOldParent=function(){if(this.childList){if(this.oldParentNode)return this.oldParentNode;if(this.added)return null}return this.node.parentNode};return e}();var a=function(){function e(){this.added=new i;this.removed=new i;this.maybeMoved=new i;this.oldPrevious=new i;this.moved=undefined}return e}();var d=function(e){t(n,e);function n(t,n){e.call(this);this.rootNode=t;this.reachableCache=undefined;this.wasReachableCache=undefined;this.anyParentsChanged=false;this.anyAttributesChanged=false;this.anyCharacterDataChanged=false;for(var i=0;i<n.length;i++){var r=n[i];switch(r.type){case"childList":this.anyParentsChanged=true;for(var s=0;s<r.removedNodes.length;s++){var o=r.removedNodes[s];this.getChange(o).removedFromParent(r.target)}for(var s=0;s<r.addedNodes.length;s++){var o=r.addedNodes[s];this.getChange(o).insertedIntoParent()}break;case"attributes":this.anyAttributesChanged=true;var a=this.getChange(r.target);a.attributeMutated(r.attributeName,r.oldValue);
break;case"characterData":this.anyCharacterDataChanged=true;var a=this.getChange(r.target);a.characterDataMutated(r.oldValue);break}}}n.prototype.getChange=function(e){var t=this.get(e);if(!t){t=new o(e);this.set(e,t)}return t};n.prototype.getOldParent=function(e){var t=this.get(e);return t?t.getOldParent():e.parentNode};n.prototype.getIsReachable=function(e){if(e===this.rootNode)return true;if(!e)return false;this.reachableCache=this.reachableCache||new i;var t=this.reachableCache.get(e);if(t===undefined){t=this.getIsReachable(e.parentNode);this.reachableCache.set(e,t)}return t};n.prototype.getWasReachable=function(e){if(e===this.rootNode)return true;if(!e)return false;this.wasReachableCache=this.wasReachableCache||new i;var t=this.wasReachableCache.get(e);if(t===undefined){t=this.getWasReachable(this.getOldParent(e));this.wasReachableCache.set(e,t)}return t};n.prototype.reachabilityChange=function(e){if(this.getIsReachable(e)){return this.getWasReachable(e)?r.STAYED_IN:r.ENTERED}return this.getWasReachable(e)?r.EXITED:r.STAYED_OUT;
};return n}(i);var c=function(){function e(e,t,n,r,s){this.rootNode=e;this.mutations=t;this.selectors=n;this.calcReordered=r;this.calcOldPreviousSibling=s;this.treeChanges=new d(e,t);this.entered=[];this.exited=[];this.stayedIn=new i;this.visited=new i;this.childListChangeMap=undefined;this.characterDataOnly=undefined;this.matchCache=undefined;this.processMutations()}e.prototype.processMutations=function(){if(!this.treeChanges.anyParentsChanged&&!this.treeChanges.anyAttributesChanged)return;var e=this.treeChanges.keys();for(var t=0;t<e.length;t++){this.visitNode(e[t],undefined)}};e.prototype.visitNode=function(e,t){if(this.visited.has(e))return;this.visited.set(e,true);var n=this.treeChanges.get(e);var i=t;if(n&&n.childList||i==undefined)i=this.treeChanges.reachabilityChange(e);if(i===r.STAYED_OUT)return;this.matchabilityChange(e);if(i===r.ENTERED){this.entered.push(e)}else if(i===r.EXITED){this.exited.push(e);this.ensureHasOldPreviousSiblingIfNeeded(e)}else if(i===r.STAYED_IN){var s=r.STAYED_IN;
if(n&&n.childList){if(n.oldParentNode!==e.parentNode){s=r.REPARENTED;this.ensureHasOldPreviousSiblingIfNeeded(e)}else if(this.calcReordered&&this.wasReordered(e)){s=r.REORDERED}}this.stayedIn.set(e,s)}if(i===r.STAYED_IN)return;for(var o=e.firstChild;o;o=o.nextSibling){this.visitNode(o,i)}};e.prototype.ensureHasOldPreviousSiblingIfNeeded=function(e){if(!this.calcOldPreviousSibling)return;this.processChildlistChanges();var t=e.parentNode;var n=this.treeChanges.get(e);if(n&&n.oldParentNode)t=n.oldParentNode;var i=this.childListChangeMap.get(t);if(!i){i=new a;this.childListChangeMap.set(t,i)}if(!i.oldPrevious.has(e)){i.oldPrevious.set(e,e.previousSibling)}};e.prototype.getChanged=function(e,t,n){this.selectors=t;this.characterDataOnly=n;for(var i=0;i<this.entered.length;i++){var s=this.entered[i];var o=this.matchabilityChange(s);if(o===r.ENTERED||o===r.STAYED_IN)e.added.push(s)}var a=this.stayedIn.keys();for(var i=0;i<a.length;i++){var s=a[i];var o=this.matchabilityChange(s);if(o===r.ENTERED){
e.added.push(s)}else if(o===r.EXITED){e.removed.push(s)}else if(o===r.STAYED_IN&&(e.reparented||e.reordered)){var d=this.stayedIn.get(s);if(e.reparented&&d===r.REPARENTED)e.reparented.push(s);else if(e.reordered&&d===r.REORDERED)e.reordered.push(s)}}for(var i=0;i<this.exited.length;i++){var s=this.exited[i];var o=this.matchabilityChange(s);if(o===r.EXITED||o===r.STAYED_IN)e.removed.push(s)}};e.prototype.getOldParentNode=function(e){var t=this.treeChanges.get(e);if(t&&t.childList)return t.oldParentNode?t.oldParentNode:null;var n=this.treeChanges.reachabilityChange(e);if(n===r.STAYED_OUT||n===r.ENTERED)throw Error("getOldParentNode requested on invalid node.");return e.parentNode};e.prototype.getOldPreviousSibling=function(e){var t=e.parentNode;var n=this.treeChanges.get(e);if(n&&n.oldParentNode)t=n.oldParentNode;var i=this.childListChangeMap.get(t);if(!i)throw Error("getOldPreviousSibling requested on invalid node.");return i.oldPrevious.get(e)};e.prototype.getOldAttribute=function(e,t){
var n=this.treeChanges.get(e);if(!n||!n.attributes)throw Error("getOldAttribute requested on invalid node.");var i=n.getAttributeOldValue(t);if(i===undefined)throw Error("getOldAttribute requested for unchanged attribute name.");return i};e.prototype.attributeChangedNodes=function(e){if(!this.treeChanges.anyAttributesChanged)return{};var t;var n;if(e){t={};n={};for(var i=0;i<e.length;i++){var s=e[i];t[s]=true;n[s.toLowerCase()]=s}}var o={};var a=this.treeChanges.keys();for(var i=0;i<a.length;i++){var d=a[i];var c=this.treeChanges.get(d);if(!c.attributes)continue;if(r.STAYED_IN!==this.treeChanges.reachabilityChange(d)||r.STAYED_IN!==this.matchabilityChange(d)){continue}var l=d;var f=c.getAttributeNamesMutated();for(var h=0;h<f.length;h++){var s=f[h];if(t&&!t[s]&&!(c.isCaseInsensitive&&n[s])){continue}var u=c.getAttributeOldValue(s);if(u===l.getAttribute(s))continue;if(n&&c.isCaseInsensitive)s=n[s];o[s]=o[s]||[];o[s].push(l)}}return o};e.prototype.getOldCharacterData=function(e){var t=this.treeChanges.get(e);
if(!t||!t.characterData)throw Error("getOldCharacterData requested on invalid node.");return t.characterDataOldValue};e.prototype.getCharacterDataChanged=function(){if(!this.treeChanges.anyCharacterDataChanged)return[];var e=this.treeChanges.keys();var t=[];for(var n=0;n<e.length;n++){var i=e[n];if(r.STAYED_IN!==this.treeChanges.reachabilityChange(i))continue;var s=this.treeChanges.get(i);if(!s.characterData||i.textContent==s.characterDataOldValue)continue;t.push(i)}return t};e.prototype.computeMatchabilityChange=function(e,t){if(!this.matchCache)this.matchCache=[];if(!this.matchCache[e.uid])this.matchCache[e.uid]=new i;var n=this.matchCache[e.uid];var r=n.get(t);if(r===undefined){r=e.matchabilityChange(t,this.treeChanges.get(t));n.set(t,r)}return r};e.prototype.matchabilityChange=function(e){var t=this;if(this.characterDataOnly){switch(e.nodeType){case Node.COMMENT_NODE:case Node.TEXT_NODE:return r.STAYED_IN;default:return r.STAYED_OUT}}if(!this.selectors)return r.STAYED_IN;if(e.nodeType!==Node.ELEMENT_NODE)return r.STAYED_OUT;
var n=e;var i=this.selectors.map(function(e){return t.computeMatchabilityChange(e,n)});var s=r.STAYED_OUT;var o=0;while(s!==r.STAYED_IN&&o<i.length){switch(i[o]){case r.STAYED_IN:s=r.STAYED_IN;break;case r.ENTERED:if(s===r.EXITED)s=r.STAYED_IN;else s=r.ENTERED;break;case r.EXITED:if(s===r.ENTERED)s=r.STAYED_IN;else s=r.EXITED;break}o++}return s};e.prototype.getChildlistChange=function(e){var t=this.childListChangeMap.get(e);if(!t){t=new a;this.childListChangeMap.set(e,t)}return t};e.prototype.processChildlistChanges=function(){if(this.childListChangeMap)return;this.childListChangeMap=new i;for(var e=0;e<this.mutations.length;e++){var t=this.mutations[e];if(t.type!="childList")continue;if(this.treeChanges.reachabilityChange(t.target)!==r.STAYED_IN&&!this.calcOldPreviousSibling)continue;var n=this.getChildlistChange(t.target);var s=t.previousSibling;function o(e,t){if(!e||n.oldPrevious.has(e)||n.added.has(e)||n.maybeMoved.has(e))return;if(t&&(n.added.has(t)||n.maybeMoved.has(t)))return;n.oldPrevious.set(e,t);
}for(var a=0;a<t.removedNodes.length;a++){var d=t.removedNodes[a];o(d,s);if(n.added.has(d)){n.added["delete"](d)}else{n.removed.set(d,true);n.maybeMoved["delete"](d)}s=d}o(t.nextSibling,s);for(var a=0;a<t.addedNodes.length;a++){var d=t.addedNodes[a];if(n.removed.has(d)){n.removed["delete"](d);n.maybeMoved.set(d,true)}else{n.added.set(d,true)}}}};e.prototype.wasReordered=function(e){if(!this.treeChanges.anyParentsChanged)return false;this.processChildlistChanges();var t=e.parentNode;var n=this.treeChanges.get(e);if(n&&n.oldParentNode)t=n.oldParentNode;var r=this.childListChangeMap.get(t);if(!r)return false;if(r.moved)return r.moved.get(e);r.moved=new i;var s=new i;function o(e){if(!e)return false;if(!r.maybeMoved.has(e))return false;var t=r.moved.get(e);if(t!==undefined)return t;if(s.has(e)){t=true}else{s.set(e,true);t=l(e)!==d(e)}if(s.has(e)){s["delete"](e);r.moved.set(e,t)}else{t=r.moved.get(e)}return t}var a=new i;function d(e){var t=a.get(e);if(t!==undefined)return t;t=r.oldPrevious.get(e);
while(t&&(r.removed.has(t)||o(t))){t=d(t)}if(t===undefined)t=e.previousSibling;a.set(e,t);return t}var c=new i;function l(e){if(c.has(e))return c.get(e);var t=e.previousSibling;while(t&&(r.added.has(t)||o(t)))t=t.previousSibling;c.set(e,t);return t}r.maybeMoved.keys().forEach(o);return r.moved.get(e)};return e}();var l=function(){function e(e,t){var n=this;this.projection=e;this.added=[];this.removed=[];this.reparented=t.all||t.element||t.characterData?[]:undefined;this.reordered=t.all?[]:undefined;e.getChanged(this,t.elementFilter,t.characterData);if(t.all||t.attribute||t.attributeList){var i=t.attribute?[t.attribute]:t.attributeList;var r=e.attributeChangedNodes(i);if(t.attribute){this.valueChanged=r[t.attribute]||[]}else{this.attributeChanged=r;if(t.attributeList){t.attributeList.forEach(function(e){if(!n.attributeChanged.hasOwnProperty(e))n.attributeChanged[e]=[]})}}}if(t.all||t.characterData){var s=e.getCharacterDataChanged();if(t.characterData)this.valueChanged=s;else this.characterDataChanged=s;
}if(this.reordered)this.getOldPreviousSibling=e.getOldPreviousSibling.bind(e)}e.prototype.getOldParentNode=function(e){return this.projection.getOldParentNode(e)};e.prototype.getOldAttribute=function(e,t){return this.projection.getOldAttribute(e,t)};e.prototype.getOldCharacterData=function(e){return this.projection.getOldCharacterData(e)};e.prototype.getOldPreviousSibling=function(e){return this.projection.getOldPreviousSibling(e)};return e}();var f=/[a-zA-Z_]+/;var h=/[a-zA-Z0-9_\-]+/;function u(e){return'"'+e.replace(/"/,'\\"')+'"'}var p=function(){function e(){}e.prototype.matches=function(e){if(e===null)return false;if(this.attrValue===undefined)return true;if(!this.contains)return this.attrValue==e;var t=e.split(" ");for(var n=0;n<t.length;n++){if(this.attrValue===t[n])return true}return false};e.prototype.toString=function(){if(this.attrName==="class"&&this.contains)return"."+this.attrValue;if(this.attrName==="id"&&!this.contains)return"#"+this.attrValue;if(this.contains)return"["+this.attrName+"~="+u(this.attrValue)+"]";
if("attrValue"in this)return"["+this.attrName+"="+u(this.attrValue)+"]";return"["+this.attrName+"]"};return e}();var g=function(){function e(){this.uid=e.nextUid++;this.qualifiers=[]}Object.defineProperty(e.prototype,"caseInsensitiveTagName",{get:function(){return this.tagName.toUpperCase()},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"selectorString",{get:function(){return this.tagName+this.qualifiers.join("")},enumerable:true,configurable:true});e.prototype.isMatching=function(t){return t[e.matchesSelector](this.selectorString)};e.prototype.wasMatching=function(e,t,n){if(!t||!t.attributes)return n;var i=t.isCaseInsensitive?this.caseInsensitiveTagName:this.tagName;if(i!=="*"&&i!==e.tagName)return false;var r=[];var s=false;for(var o=0;o<this.qualifiers.length;o++){var a=this.qualifiers[o];var d=t.getAttributeOldValue(a.attrName);r.push(d);s=s||d!==undefined}if(!s)return n;for(var o=0;o<this.qualifiers.length;o++){var a=this.qualifiers[o];var d=r[o];if(d===undefined)d=e.getAttribute(a.attrName);
if(!a.matches(d))return false}return true};e.prototype.matchabilityChange=function(e,t){var n=this.isMatching(e);if(n)return this.wasMatching(e,t,n)?r.STAYED_IN:r.ENTERED;else return this.wasMatching(e,t,n)?r.EXITED:r.STAYED_OUT};e.parseSelectors=function(t){var n=[];var i;var r;function s(){if(i){if(r){i.qualifiers.push(r);r=undefined}n.push(i)}i=new e}function o(){if(r)i.qualifiers.push(r);r=new p}var a=/\s/;var d;var c="Invalid or unsupported selector syntax.";var l=1;var u=2;var g=3;var m=4;var v=5;var x=6;var C=7;var S=8;var b=9;var E=10;var _=11;var y=12;var w=13;var T=14;var N=l;var q=0;while(q<t.length){var R=t[q++];switch(N){case l:if(R.match(f)){s();i.tagName=R;N=u;break}if(R=="*"){s();i.tagName="*";N=g;break}if(R=="."){s();o();i.tagName="*";r.attrName="class";r.contains=true;N=m;break}if(R=="#"){s();o();i.tagName="*";r.attrName="id";N=m;break}if(R=="["){s();o();i.tagName="*";r.attrName="";N=x;break}if(R.match(a))break;throw Error(c);case u:if(R.match(h)){i.tagName+=R;break}if(R=="."){
o();r.attrName="class";r.contains=true;N=m;break}if(R=="#"){o();r.attrName="id";N=m;break}if(R=="["){o();r.attrName="";N=x;break}if(R.match(a)){N=T;break}if(R==","){N=l;break}throw Error(c);case g:if(R=="."){o();r.attrName="class";r.contains=true;N=m;break}if(R=="#"){o();r.attrName="id";N=m;break}if(R=="["){o();r.attrName="";N=x;break}if(R.match(a)){N=T;break}if(R==","){N=l;break}throw Error(c);case m:if(R.match(f)){r.attrValue=R;N=v;break}throw Error(c);case v:if(R.match(h)){r.attrValue+=R;break}if(R=="."){o();r.attrName="class";r.contains=true;N=m;break}if(R=="#"){o();r.attrName="id";N=m;break}if(R=="["){o();N=x;break}if(R.match(a)){N=T;break}if(R==","){N=l;break}throw Error(c);case x:if(R.match(f)){r.attrName=R;N=C;break}if(R.match(a))break;throw Error(c);case C:if(R.match(h)){r.attrName+=R;break}if(R.match(a)){N=S;break}if(R=="~"){r.contains=true;N=b;break}if(R=="="){r.attrValue="";N=_;break}if(R=="]"){N=g;break}throw Error(c);case S:if(R=="~"){r.contains=true;N=b;break}if(R=="="){r.attrValue="";
N=_;break}if(R=="]"){N=g;break}if(R.match(a))break;throw Error(c);case b:if(R=="="){r.attrValue="";N=_;break}throw Error(c);case E:if(R=="]"){N=g;break}if(R.match(a))break;throw Error(c);case _:if(R.match(a))break;if(R=='"'||R=="'"){d=R;N=w;break}r.attrValue+=R;N=y;break;case y:if(R.match(a)){N=E;break}if(R=="]"){N=g;break}if(R=="'"||R=='"')throw Error(c);r.attrValue+=R;break;case w:if(R==d){N=E;break}r.attrValue+=R;break;case T:if(R.match(a))break;if(R==","){N=l;break}throw Error(c)}}switch(N){case l:case u:case g:case v:case T:s();break;default:throw Error(c)}if(!n.length)throw Error(c);return n};e.nextUid=1;e.matchesSelector=function(){var e=document.createElement("div");if(typeof e["webkitMatchesSelector"]==="function")return"webkitMatchesSelector";if(typeof e["mozMatchesSelector"]==="function")return"mozMatchesSelector";if(typeof e["msMatchesSelector"]==="function")return"msMatchesSelector";return"matchesSelector"}();return e}();var m=/^([a-zA-Z:_]+[a-zA-Z0-9_\-:\.]*)$/;function v(e){
if(typeof e!="string")throw Error("Invalid request opion. attribute must be a non-zero length string.");e=e.trim();if(!e)throw Error("Invalid request opion. attribute must be a non-zero length string.");if(!e.match(m))throw Error("Invalid request option. invalid attribute name: "+e);return e}function x(e){if(!e.trim().length)throw Error("Invalid request option: elementAttributes must contain at least one attribute.");var t={};var n={};var i=e.split(/\s+/);for(var r=0;r<i.length;r++){var s=i[r];if(!s)continue;var s=v(s);var o=s.toLowerCase();if(t[o])throw Error("Invalid request option: observing multiple case variations of the same attribute is not supported.");n[s]=true;t[o]=true}return Object.keys(n)}function C(e){var t={};e.forEach(function(e){e.qualifiers.forEach(function(e){t[e.attrName]=true})});return Object.keys(t)}var S=function(){function e(t){var i=this;this.connected=false;this.options=e.validateOptions(t);this.observerOptions=e.createObserverOptions(this.options.queries);this.root=this.options.rootNode;
this.callback=this.options.callback;this.elementFilter=Array.prototype.concat.apply([],this.options.queries.map(function(e){return e.elementFilter?e.elementFilter:[]}));if(!this.elementFilter.length)this.elementFilter=undefined;this.calcReordered=this.options.queries.some(function(e){return e.all});this.queryValidators=[];if(e.createQueryValidator){this.queryValidators=this.options.queries.map(function(t){return e.createQueryValidator(i.root,t)})}this.observer=new n(function(e){i.observerCallback(e)});this.reconnect()}e.createObserverOptions=function(e){var t={childList:true,subtree:true};var n;function i(e){if(t.attributes&&!n)return;t.attributes=true;t.attributeOldValue=true;if(!e){n=undefined;return}n=n||{};e.forEach(function(e){n[e]=true;n[e.toLowerCase()]=true})}e.forEach(function(e){if(e.characterData){t.characterData=true;t.characterDataOldValue=true;return}if(e.all){i();t.characterData=true;t.characterDataOldValue=true;return}if(e.attribute){i([e.attribute.trim()]);return}var n=C(e.elementFilter).concat(e.attributeList||[]);
if(n.length)i(n)});if(n)t.attributeFilter=Object.keys(n);return t};e.validateOptions=function(t){for(var n in t){if(!(n in e.optionKeys))throw Error("Invalid option: "+n)}if(typeof t.callback!=="function")throw Error("Invalid options: callback is required and must be a function");if(!t.queries||!t.queries.length)throw Error("Invalid options: queries must contain at least one query request object.");var i={callback:t.callback,rootNode:t.rootNode||document,observeOwnChanges:!!t.observeOwnChanges,oldPreviousSibling:!!t.oldPreviousSibling,queries:[]};for(var r=0;r<t.queries.length;r++){var s=t.queries[r];if(s.all){if(Object.keys(s).length>1)throw Error("Invalid request option. all has no options.");i.queries.push({all:true});continue}if("attribute"in s){var o={attribute:v(s.attribute)};o.elementFilter=g.parseSelectors("*["+o.attribute+"]");if(Object.keys(s).length>1)throw Error("Invalid request option. attribute has no options.");i.queries.push(o);continue}if("element"in s){var a=Object.keys(s).length;
var o={element:s.element,elementFilter:g.parseSelectors(s.element)};if(s.hasOwnProperty("elementAttributes")){o.attributeList=x(s.elementAttributes);a--}if(a>1)throw Error("Invalid request option. element only allows elementAttributes option.");i.queries.push(o);continue}if(s.characterData){if(Object.keys(s).length>1)throw Error("Invalid request option. characterData has no options.");i.queries.push({characterData:true});continue}throw Error("Invalid request option. Unknown query request.")}return i};e.prototype.createSummaries=function(e){if(!e||!e.length)return[];var t=new c(this.root,e,this.elementFilter,this.calcReordered,this.options.oldPreviousSibling);var n=[];for(var i=0;i<this.options.queries.length;i++){n.push(new l(t,this.options.queries[i]))}return n};e.prototype.checkpointQueryValidators=function(){this.queryValidators.forEach(function(e){if(e)e.recordPreviousState()})};e.prototype.runQueryValidators=function(e){this.queryValidators.forEach(function(t,n){if(t)t.validate(e[n]);
})};e.prototype.changesToReport=function(e){return e.some(function(e){var t=["added","removed","reordered","reparented","valueChanged","characterDataChanged"];if(t.some(function(t){return e[t]&&e[t].length}))return true;if(e.attributeChanged){var n=Object.keys(e.attributeChanged);var i=n.some(function(t){return!!e.attributeChanged[t].length});if(i)return true}return false})};e.prototype.observerCallback=function(e){if(!this.options.observeOwnChanges)this.observer.disconnect();var t=this.createSummaries(e);this.runQueryValidators(t);if(this.options.observeOwnChanges)this.checkpointQueryValidators();if(this.changesToReport(t))this.callback(t);if(!this.options.observeOwnChanges&&this.connected){this.checkpointQueryValidators();this.observer.observe(this.root,this.observerOptions)}};e.prototype.reconnect=function(){if(this.connected)throw Error("Already connected");this.observer.observe(this.root,this.observerOptions);this.connected=true;this.checkpointQueryValidators()};e.prototype.takeSummaries=function(){
if(!this.connected)throw Error("Not connected");var e=this.createSummaries(this.observer.takeRecords());return this.changesToReport(e)?e:undefined};e.prototype.disconnect=function(){var e=this.takeSummaries();this.observer.disconnect();this.connected=false;return e};e.NodeMap=i;e.parseElementFilter=g.parseSelectors;e.optionKeys={callback:true,queries:true,rootNode:true,oldPreviousSibling:true,observeOwnChanges:true};return e}();exports.MutationSummary=S});define("qtext2/mutations",["shared/polyfills","qtext2/base","qtext2/section","qtext2/sections/plain","qtext2/span","qtext2/position","qtext2/util","shared/log","shared/util","shared/Class","third_party/mutation-summary"],function S(require,exports,e){var t=require("qtext2/base"),n=t.Doc,i=require("qtext2/section"),r=i.Section,s=require("qtext2/sections/plain").PlainSection,o=require("qtext2/span").Span,a=require("qtext2/position").Position,d=require("qtext2/util").Util,c=require("shared/log").log,l=require("shared/util").extend,f=require("shared/Class").Class;
c=c.bind(c,"qtext2");var h=function(){c.apply(c,arguments)};exports.MutationFixer=f.extend({__init__:function(e){this.doc=e;try{var t=require("third_party/mutation-summary");this.mutationSummary=new t.MutationSummary({rootNode:e.node,observeOwnChanges:false,queries:[{all:true}],callback:this.handleMutationSummaries.bind(this)})}catch(n){h("Mutation summary initialization failed.")}},pause:function(){this.mutationSummary.disconnect()},resume:function(){this.mutationSummary.reconnect()},handleMutationSummaries:function(e){var t=e[0];h("Mutation summary",t);this.handleNodesAdded(t);this.handleNodesRemoved(t);this.handleNodeAttributeChanges(t);this.doc.trigger("meaningfulChange")},handleNodesAdded:function(e){var t=e.added;if(!(t&&t.length!==0)){return}var n=this;t.forEach(function(e){try{n._handleNodeAdded(e)}catch(t){h("Error while handling added node",t,t.stack)}})},_handleNodeAdded:function(e){if(this.isValidQText2Node(e)){h("Valid qtext2 node added",e);return}if(!e.parentElement){h("Node detached from a previous operation",e);
return}if(!this.isValidQText2Node(e.parentElement)){h("Skipping invalid node added",e);h("Processing node.parentElement instead",e.parentElement);return}h("Fixing invalid node added:",e,e.parentElement);var t;if(this.isQText2SpanContent(e.parentElement)){t=this._handleNodeAddedToSpanContent(e)}else if(this.isQText2Span(e.parentElement)){t=this._handleNodeAddedToSpan(e,this.getQText2Span(e.parentElement))}else if(this.isQText2Container(e.parentElement)){t=this._handleNodeAddedToContainer(e,this.getQText2Container(e.parentElement))}else{h("Unhandled node.",e,e.parentElement)}if(t){this.doc.moveCaret(t)}return},_handleNodeAddedToSpanContent:function(e){var t=this.getQText2Span(e.parentElement.parentElement),n=this._getModifiersFromNode(e),i,r,s,a,d;if(this.nodeShouldBeSingleChild(e)){i=t.parent;r=t.previous();s=r?r.last():t.next().first();i.removeChild(t);return s}i=t.parent;a=e.parentElement.childNodes[0];d=true;while(a){if(a==e){d=false}else{i.insertBefore(new o(a.textContent,t.modifiers),d?t:t.nextSibling());
}a=a.nextSibling}t.setText(e.textContent);this._applyModifier(t,n);this.safeRemoveNodeFromDom(e);return t.last()},_handleNodeAddedToSpan:function(e,t,n){n=l(this._getModifiersFromNode(e),n||{});var i=t.node.textContent,r=e,s=e.textContent.length;while(r.previousSibling){r=r.previousSibling;s+=r.textContent.length}var o=Array.prototype.slice.call(t.node.childNodes);for(var d=0;d<o.length;d++){if(o[d]!=t._content){this.safeRemoveNodeFromDom(o[d])}}if(!t._content){t._content=t.createContentNode()}if(t.node!=t._content.parentElement){t.node.appendChild(t._content)}t.setText(i);this._applyModifier(t,n);return new a(t,s)},_handleNodeAddedToContainer:function(e,t,n){n=l(this._getModifiersFromNode(e),n||{});var i=this.doc,r,a,c,f;if(t.hasChild(this.getQText2Container(e))){this._applyModifiersToContainer(this.getQText2Container(e),n);return}t.children.forEach(function(e){if(!i.contains(e.node)){t.removeChild(e)}});if(d.isTextNode(e)){if(t.kind=="section"){a=r=new o(e.textContent,n)}else if(t.kind=="doc"){
r=new o(e.textContent,n);a=new s([r])}this._replaceNodeWithContainer(e,a,t);f=a.last()}else if(e.nodeName=="BR"){if(t.kind=="section"){f=this._splitSectionAtNode(e,t)}else if(t.kind=="doc"){a=new s;this._replaceNodeWithContainer(e,a,t);f=a.first()}}c=this._emptyNodeContents(e);for(var h=0;h<c.length;h++){f=this._handleNodeAddedToContainer(c[h],t,n)}return f},_emptyNodeContents:function(e){var t=Array.prototype.slice.call(e.childNodes);for(var n=0;n<t.length;n++){e.parentElement.insertBefore(t[n],e)}this.safeRemoveNodeFromDom(e);return t},_splitSectionAtNode:function(e,t){var n,i;n=this.getQText2Span(e.nextSibling);if(n){i=n.first()}n=this.getQText2Span(e.previousSibling);if(n){i=n.last()}this.safeRemoveNodeFromDom(e);i=i||t.last();return t.split(i)},_replaceNodeWithContainer:function(e,t,n){var i;i=this.getQText2Container(e.nextSibling,t.Class);if(i){n.insertBefore(t,i);this.safeRemoveNodeFromDom(e);return}i=this.getQText2Container(e.previousSibling,t.Class);if(i){n.insertAfter(t,i);this.safeRemoveNodeFromDom(e);
return}n.appendChild(t);n.node.insertBefore(t.node,n.node.firstElementChild);this.safeRemoveNodeFromDom(e)},safeRemoveNodeFromDom:function(e){if(!e.parentElement){return}d.safeRemoveChild(e,e.parentElement)},_getQText2ContainerType:function(e,t){return t.is(e)&&t.get(e)},isQText2SpanContent:function(e){return!!e.qtextSpanContent},getQText2Span:function(e){return this._getQText2ContainerType(e,o)},isQText2Span:function(e){return!!this.getQText2Span(e)},getQText2Section:function(e){return this._getQText2ContainerType(e,r)},isQText2Section:function(e){return!!this.getQText2Section(e)},getQText2Doc:function(e){return this._getQText2ContainerType(e,n)},isQText2Doc:function(e){return!!this.getQText2Doc(e)},isValidQText2Node:function(e){if(!e){return false}if(this.isQText2Container(e)){return true}if(this.isQText2SpanContent(e)){return true}if(!e.parentElement){return false}if(this.isQText2SpanContent(e.parentElement)){if(d.isTextNode(e)){return true}if(this.nodeShouldBeSingleChild(e)){var t=this.getQText2Span(e.parentElement.parentElement);
return t&&t.parent.children.length==1}}return false},nodeShouldBeSingleChild:function(e){return e&&(e.nodeName=="IMG"||e.nodeName=="BR"||e.nodeName=="IFRAME"||e.nodeName=="TWITTERWIDGET"||e.className=="twitter-tweet")},getQText2Container:function(e){var t=[o,r,n];var i;for(var s=0;s<t.length;s++){i=this._getQText2ContainerType(e,t[s]);if(i){break}}return i},isQText2Container:function(e){return!!this.getQText2Container(e)},handleNodesRemoved:function(e){var t=e.removed;if(!(t&&t.length!==0)){return}var n=this;t.forEach(function(t){try{n._handleNodeRemoved(t,e.getOldParentNode(t))}catch(i){h("Error while handling removed node",i,i.stack)}})},_handleNodeRemoved:function(e,t){var i,s;if(o.is(t)){i=o.get(t);s=i.parent;if(this.doc.contains(t)||this.doc.hasChild(s)&&s.hasChild(i)){s.removeChild(i);if(s.children.length===0){this.doc.removeChild(s)}}}else if(r.is(t)){s=r.get(t);if(!s){return}if(o.is(e)){i=o.get(e);if(s.hasChild(i)){s.removeChild(i)}}if(s.children.length===0){this.doc.removeChild(s);
}}else if(n.is(t)){if(r.is(e)){s=r.get(e);if(this.doc.hasChild(s)){this.doc.removeChild(s)}}}if(!this.doc.node.firstElementChild){this.doc.clear();this.doc.focus()}},handleNodeAttributeChanges:function(e){var t=e.attributeChanged;if(t.style&&t.style.length){t.style.forEach(this._handleNodeStyleAttributeChanged.bind(this))}},_handleNodeStyleAttributeChanged:function(e){h("Fixing external node style changes:",e);var t=this._getModifiersFromNode(e);e.style.cssText="";var n=[];if(o.is(e)){n.push(o.get(e))}else if(o.is(e.parentElement)){n.push(o.get(e.parentElement))}else if(r.is(e)){var i=r.get(e);var s=i.firstChild();while(s){n.push(s);s=s.nextSibling()}}this._applyModifiers(n,t)},_getModifiersFromNode:function(e){var t={};if(e.style){var n=e.style.cssText;n=n.replace(/\s|;/g,"");if(n=="font-weight:bold"){t.bold=true}else if(n=="font-weight:normal"){t.bold=false}else if(n=="text-decoration:none"){t.underline=false}else if(n=="text-decoration:underline"){t.underline=false}}var i={B:"bold",STRONG:"bold",
I:"italic",EM:"italic"}[e.nodeName];if(i){t[i]=true}return t},_applyModifiers:function(e,t){var n=this;e.forEach(function(e){n._applyModifier(e,t)})},_applyModifiersToContainer:function(e,t){var n=[];if(e.kind=="span"){n=[e]}else if(e.kind=="section"){n=e.children}else if(e.kind=="doc"){e.children.forEach(function(e){n.push.apply(n,e.children)})}this._applyModifiers(n,t)},_applyModifier:function(e,t){var n=Object.keys(t);for(var i=0;i<n.length;i++){var r=n[i];if(t[r]){e.setModifier(r,true)}else{e.removeModifier(r)}}}})});define("shared/parse_html",["shared/polyfills","shared/browser"],function b(require,exports,e){var t=require("shared/browser");exports.htmlToNode=function(e){var n;if(!(t.msie&&t.version<9)&&document.implementation&&document.implementation.createHTMLDocument){var i=document.implementation.createHTMLDocument("title for old FF versions");n=i.createElement("DIV")}else{n=document.createElement("DIV")}n.innerHTML=e;return n}});define("qtext2/parser",["shared/polyfills","shared/Class","shared/log","qtext2/util","shared/util","qtext2/position","shared/parse_html","qtext2/span","qtext2/base","qtext2/constants","qtext2/sections/plain","qtext2/sections/code","qtext2/sections/lists","qtext2/sections/image","qtext2/sections/horizontal_rule"],function E(require,exports,e){
var t=require("shared/Class").Class,n=require("shared/log").log,i=require("qtext2/util").Util,r=require("shared/util").extend,s=require("qtext2/position").Position,o=require("shared/parse_html").htmlToNode,a=require("qtext2/span").Span,d=require("qtext2/base"),c=d.Doc,l=require("qtext2/constants").CONTENT_TYPES,f=require("qtext2/sections/plain").PlainSection,h=require("qtext2/sections/code").CodeSection,u=require("qtext2/sections/lists").UnorderedListSection,p=require("qtext2/sections/lists").OrderedListSection,g=require("qtext2/sections/image").ImageSection,m=require("qtext2/sections/horizontal_rule").HorizontalRuleSection;var v=function(e){return["B","I","U","A","EM","STRONG","MATH","CODE"].indexOf(e)!=-1};var x=function(e){return["OL","UL"].indexOf(e)!=-1};var C=function(e){return["H1","H2","H3","H4","H5"].indexOf(e)!=-1};var S=function(e){return e=="BLOCKQUOTE"};var b=function(e){var t=["STYLE","LINK"];if(e.nodeType==e.COMMENT_NODE){return true}return t.indexOf(e.nodeName)!=-1};var E=t.extend({
__init__:function(e,t){this.spans=t||[];this.modifiers=r(e,{});this.indent=0;this.content=""},visit:function(e){this._enter(e);this._exit(e)},_visitChildren:function(e){for(var t=e.firstChild;t!==null;t=t.nextSibling){this.visit(t)}},_enter:function(e){if(i.isTextNode(e)){var t=e.textContent;t=t.replace(/\n/g," ");t=t.replace(/ {2,}/g," ");this.content+=t;return}var n=e.nodeName.toUpperCase();if(n=="BR"){this.content+="\n";return}if(this._getModifier(e)){this.modifiers[this._getModifier(e)]=this._getModifierValue(e)}this._visitChildren(e)},_exit:function(e){if(i.isTextNode(e)||e.nodeName.toUpperCase()=="BR"){this._createSpan();return}if(this._getModifier(e)){delete this.modifiers[this._getModifier(e)]}},_createSpan:function(){var e=this.content;if(!e.length){return}e=e.replace(/(\u00a0)+/gm," ");if(this.spans.length>0){var t=this.spans[this.spans.length-1];if(i.jsonEqual(t.modifiers,this.modifiers)){var n=t.getText();t.setText(n+e);this.content="";return}}this.spans.push(new a(e,this.modifiers));
this.content=""},_getModifier:function(e){return{B:"bold",STRONG:"bold",I:"italic",EM:"italic",U:"italic",A:"link",CODE:"code",MATH:"math"}[e.nodeName.toUpperCase()]},_getModifierValue:function(e){return{B:true,I:true,EM:true,U:true,A:{type:"url",url:e.href},CODE:true,MATH:true}[e.nodeName.toUpperCase()]}});var _=function(e,t,n){var i=new E(t,n);i.visit(e);return i.spans};var y=function(e,t){var n,r=e.nodeName.toUpperCase()=="OL"?p:u,s=[],o;t=t||0;i.assert(x(e.nodeName),"Unknown list type",e);for(var a=e.firstElementChild;a;a=a.nextElementSibling){n=a.nodeName.toUpperCase();if(n=="LI"){o=new r(_(a,{}));o.setIndent(t);s.push(o)}else if(x(n)){s=s.concat(y(a,t+1))}}return s};var w=function(e){var t=[],n=new h,i,r;t.push(n);for(r=e.firstChild;r;r=r.nextSibling){if(r.nodeName.toUpperCase()=="BR"){n=new h;t.push(n)}else{i=n.firstChild();i.setText(i.getText()+r.textContent)}}return t};var T=function(e,t){var n,o=[],a,d=new c({});t=t||{};var l=function(){if(o.length){var e=new f(o);if(/\S/.test(e.getText())){
d.appendChild(e);var t=e.firstChild();while(t){var n=t.getText();var i=n.indexOf("\n\n");if(i==-1){t=t.nextSibling();continue}t.setText(n.replace("\n\n",""));t.parent.split(new s(t,i));t=d.lastChild().firstChild()}}o=[]}};for(var h=e.firstChild;h;h=h.nextSibling){n=h.nodeName.toUpperCase();if(n=="SPAN"&&h.textContent.length!==0||i.isTextNode(h)||n=="BR"||v(n)){o=_(h,t,o)}else{l();if(b(h)){}else if(x(n)){d.appendChildren(y(h))}else if(C(n)){d.appendChildren(T(h,r({bold:true},t)))}else if(S(n)){a=T(h);a.forEach(function(e){e.setQuoted(true)});d.appendChildren(a)}else if(n=="HR"){d.appendChild(new m)}else if(n=="PRE"){d.appendChildren(w(h))}else if(n=="IMG"){if(!h.src.startsWith("file://")){d.appendChild(g.fromURL(h.src))}}else{d.appendChildren(T(h))}}}l();d.destroy();return d.children.slice(1,d.children.length)};var N=function(e){var t=o(e),i;i=T(t);n.log("qtext2",t);return i};var q=function(e){var t=[];if(e.length===0){return[]}i.splitLines(e).forEach(function(e){t.push(new f([new a(e)]));
});return t};var R=function(e,t){if(t==l.HTML||t==l.PUBLIC_HTML){return N(e)}if(t==l.TEXT){return q(e)}return[]};exports.parseHTML=N;exports.parseText=q;exports.parse=R});define("qtext2/command/base",["shared/polyfills","shared/Class","qtext2/modifiers"],function _(require,exports,e){var t=require("shared/Class").Class,n=require("qtext2/modifiers").canForceModifier;var i=exports.Command=t.extend({__init__:function(e){this.doc=e},exec:function(e){throw new Error("Sub-classes should implement this method.")},shouldExec:function(e){return true},run:function(e){if(!this.shouldExec(e)){return true}return this.exec.apply(this,arguments)}});exports.spanModifierToggle=function(e){return i.extend({exec:function(){this.doc.saveState();return this.doc.toggleModifier(e)},shouldExec:function(){var t=this.doc.caret.getCoveringSpans();return t.some(function(t){return t.hasModifier(e)||n(t,e)})}})};exports.sectionTypeToggle=function(e){return i.extend({exec:function(){this.doc.saveState();return this.doc.toggleSectionType(e);
}})};exports.eventProxy=function(e){return i.extend({exec:function(){return this.doc.trigger(e)}})}});define("qtext2/command/backspace",["shared/polyfills","qtext2/command/base","qtext2/position","qtext2/sections/plain"],function y(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/position").Position,i=require("qtext2/sections/plain").PlainSection;exports.Backspace=t.extend({exec:function(){this.doc.saveState();var e=this._actualBackspace();this.doc.updateSpellingSuggestions();this.doc.caret.scrollIntoViewIfNeeded();return e},_actualBackspace:function(){var e,t,r,s;if(!this.doc.caret.isCollapsed()){this.doc._deleteSelection(true);return false}r=this.doc.caret.start.clone();e=r.span.parent;t=e.previousSibling();s=r.span.getText();if(!e.isEditable()){if(this.doc.caret.start.atSectionStart()){if(t&&t.isEmpty()){this.doc.removeChild(t)}}else{if(!t){t=new i;this.doc.insertBefore(t,e)}this.doc.removeChild(e);this.doc.moveCaret(t.last());this.doc.caret.updateAndroidCaretPosition();
}return false}if(r.atDocStart()){e=this.doc.progressivelyExitSection(e);this.doc.moveCaret(e.first(),e.first(),true);return false}if(r.atSectionStart()){if(e.getIndent()>0){e.setIndent(e.getIndent()-1);this.doc.caret.updateAndroidCaretPosition()}else{if(!t.isEditable()&&!e.isEmpty()){this.doc.moveCaret(t.last())}else{this.doc.moveCaret(t.merge(e));this.doc.caret.mergeAdjacentSpans()}}return false}if(r.atSpanStart()){r.span=r.span.previous();r.offset=r.span.getLength();s=r.span.getText()}var o=s.slice(0,r.offset),a=s.slice(r.offset),d=0;for(var c=o.length;c>0;c--){if(o[c-1]!="\n"){break}d+=1}if(d==1&&a.startsWith("\n")){a=a.slice(1)}o=o.slice(0,-1);if(r.atSectionEnd()&&o.endsWith("\n")&&d===0){o=o+"\n"}r.span.setText(o+a);if(r.span.isEmpty()){r=this.doc._handleEmptySpan(r.span,true);this.doc.moveCaret(r,r,true)}else{this.doc.moveCaret(new n(r.span,o.length))}return false}})});define("qtext2/command/code",["shared/polyfills","qtext2/command/base","qtext2/sections/code","qtext2/modifiers"],function w(require,exports,e){
var t=require("qtext2/command/base").Command,n=require("qtext2/sections/code").CodeSection,i=require("qtext2/modifiers").canForceModifier;exports.Code=t.extend({exec:function(){this.doc.saveState();if(this.doc.caret.isCollapsed()){if(this.doc.formattingState.is("code")||!this.doc.allowsMultipleSections()){this.doc.toggleModifier("code")}else{this.doc.toggleSectionType(n)}return false}var e=this.doc._getSelectedSections();var t=e.some(function(e){return!e.isEditable()});if(!t&&this.doc.caret.start.atSectionStart()&&this.doc.caret.end.atSectionEnd()){this.doc.toggleSectionType(n)}else{this.doc._toggleMathOrCodeModifier("code")}return false},shouldExec:function(){if(this.doc.caret.isCollapsed()){return this.doc.caret.start.span.parent.isEditable()}var e=this.doc._getSelectedSections();var t=e.some(function(e){return!e.isEditable()});if(!t&&this.doc.caret.start.atSectionStart()&&this.doc.caret.end.atSectionEnd()){return true}var n=this.doc.caret.getCoveringSpans();return n.some(function(e){
return i(e,"code")})}})});define("qtext2/command/copy",["shared/polyfills","qtext2/command/base","qtext2/section","interface/settings","qtext2/constants","shared/client","shared/browser"],function T(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/section").Section,i=require("interface/settings").pageIsMobile,r=require("qtext2/constants").CONTENT_TYPES,s=require("shared/client"),o=require("shared/browser"),a;if(i){a=require("mobile_app2/messages")}exports.Copy=t.extend({exec:function(e,t){if(i&&s.isIOSMobileWeb()){return}if(o.msedge){return}var d=this._selectedSectionsJSON(),c=d.map(n.fromJSON),l=this.getContentForType(c,r.TEXT),f=this.getContentForType(c,r.HTML);t.clipboardData.setData(r.TEXT,l);t.clipboardData.setData(r.HTML,f);t.preventDefault();t.stopPropagation();if(i){if(s.isIOSApp()){a.send("setClipboard",{text:l,html:f})}}if(e=="cut"){this.doc._deleteSelection()}},getContentForType:function(e,t){return e.map(function(n){return n.toContent(t,e)}).join("");
},_selectedSectionsJSON:function(){if(this.doc.caret.isCollapsed()){return[]}var e=[],t=this.doc.caret.start.clone(),n=this.doc.caret.end.clone(),i=t.span,r,s;for(i=t.span;i&&i.previous()!=n.span;i=i.next()){if(t.span===i&&t.atSpanEnd()||n.span===i&&n.atSpanStart()){continue}if(r!=i.parent){r=i.parent;s=r.toJSON();s.spans=[];e.push(s)}var o=t.span===i?t.offset:undefined;var a=n.span===i?n.offset:undefined;s.spans.push(i.toJSON(o,a))}return e}})});define("qtext2/command/delete",["shared/polyfills","qtext2/command/base","qtext2/sections/plain"],function N(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/sections/plain").PlainSection;exports.Delete=t.extend({exec:function(e){this.doc.saveState();if(this.doc.caret.isCollapsed()){if(e=="delete"){return this._deleteSingle()}if(e=="delete-forward"){this.doc.moveCaretEnd(this.doc.caret.start.span.parent.last())}else if(e=="delete-backward"){this.doc.moveCaretStart(this.doc.caret.start.span.parent.first())}else if(e=="delete-next-word"){
this.doc.moveCaretEnd(this.doc.caret.start.nextWordBoundary())}else if(e=="delete-previous-word"){this.doc.moveCaretStart(this.doc.caret.start.previousWordBoundary())}}return this._deleteSelection()},_deleteSelection:function(){if(!this.doc.caret.isCollapsed()){this.doc._deleteSelection(false);return false}},_deleteSingle:function(){var e,t,i;i=this.doc.caret.start.clone();e=i.span.parent;t=e.nextSibling();if(!this.doc.caret.isCollapsed()){return}if(!e.isEditable()){if(this.doc.caret.start.atSectionEnd()){if(t&&t.isEmpty()){this.doc.removeChild(t)}}else{if(!t){t=new n;this.doc.insertBefore(t,e)}this.doc.removeChild(e);this.doc.moveCaret(t.first());this.doc.caret.updateAndroidCaretPosition()}return false}if(i.atDocEnd()){return false}if(i.atSectionEnd()){e=i.span.parent;this.doc.moveCaret(e.merge(e.nextSibling()));return false}if(i.atSpanEnd()){i.span=i.span.next();i.offset=0}i.span.deleteText(i.offset,i.offset+1);if(i.span.isEmpty()){this.doc.moveCaret(this.doc._handleEmptySpan(i.span,true));
}else{this.doc.moveCaret(i)}return false}})});define("qtext2/command/indent",["shared/polyfills","qtext2/command/base","qtext2/sections/code","qtext2/position"],function q(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/sections/code").CodeSection,i=require("qtext2/position").Position;exports.Indent=t.extend({exec:function(e){if(e=="indent"){return this._indent()}else{return this._deindent()}},_maybeInsertTab:function(){var e=this.doc.caret.isCollapsed(),t=this.doc.caret.start.clone(),r=t.span,s=r.parent,o=r.getText(),a=t.offset;if(e&&s instanceof n){r.setText(o.slice(0,a)+"	"+o.slice(a));this.doc.moveCaret(new i(r,a+1));return true}return false},_afterIndent:function(e){if(e){this.doc.forceDomReflow()}this.doc.updateCaret()},_indent:function(){if(this._maybeInsertTab()){return false}var e=this.doc._getSelectedSections();var t=false;e.forEach(function(e){if(e.setIndent(e.getIndent()+1)){t=true}});this._afterIndent(t);return!t},_deindent:function(){var e=this.doc._getSelectedSections();
var t=false;e.forEach(function(e){if(e.setIndent(e.getIndent()-1)){t=true}});this._afterIndent(t);return!t}})});define("qtext2/command/image",["shared/polyfills","qtext2/command/base","qtext2/sections/image","qtext2/sections/plain","qtext2/sections/lists"],function R(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/sections/image").ImageSection,i=require("qtext2/sections/plain").PlainSection,r=require("qtext2/sections/lists").OrderedListSection;exports.Image=t.extend({exec:function(e,t){if(t.length===0){return}this.doc.saveState();var s=this.doc.caret.start.clone(),o=s.span.parent,a,d;if(s.atSectionStart()){a=o}else{if(!s.atSectionEnd()){o.split(s)}a=o.nextSibling()}for(d=0;d<t.length;d++){this.doc.insertBefore(n.fromURL(t[d]),a)}if(!a){a=new i;this.doc.appendChild(a)}this.doc.moveCaret(a.first());if(a instanceof r){this.doc.forceDomReflow()}}})});define("qtext2/command/link",["shared/polyfills","qtext2/command/base","qtext2/span","qtext2/util","qtext2/position","qtext2/extension/link_interaction","qtext2/modifiers"],function O(require,exports,e){
var t=require("qtext2/command/base").Command,n=require("qtext2/span").Span,i=require("qtext2/util").Util,r=require("qtext2/position").Position,s=require("qtext2/extension/link_interaction").linkInteractionEnabled,o=require("qtext2/modifiers").canForceModifier;exports.Link=t.extend({exec:function(){var e=this.doc.caret.start.span,t,n,i;if(!e.isEditable()){return false}if(e.hasModifier("link")){if(!this.doc.caret.isCollapsed()){this.doc.saveState()}this.doc.formattingState.toggleModifier(this.doc.caret,"link");this.doc._getSelectedSpans(true).forEach(function(e){e.removeModifier("link")});if(!s()){return false}t=e.getModifier("link");i=false}else if(e.hasModifier("citation")){t=e.getModifier("citation").target;i=true}if(t){n=t.url}this.doc.linkSelector.getExternalURL(this.onLinkInput.bind(this),n,i);return false},shouldExec:function(){return o(this.doc.caret.start.span,"link")},onLinkInput:function(e){var t=this.doc.caret.isCollapsed(),o=this.doc.caret.start.clone(),a=this.doc._getSelectedSpans(true),d=e.url,c=e.isCitation,l=this.doc.caret.start.span,f=c&&l.hasModifier("citation")||!c&&l.hasModifier("link"),h=f?l.getText():d,u,p,g;
this.doc.saveState();if(d){d=i.ensureProtocol(d);u={type:"url",url:d};if(!c){a=this.doc._mergeSpansBySection(a)}if(t){p=this.doc._insertOrModifyLink(h,u,c,!s());o=new r(p.nextSibling(),1)}else{if(c){p=new n(" ",{citation:{target:u}});g=a[a.length-1];g.parent.insertAfter(p,g)}else{a.forEach(function(e){e.setModifier("link",u)})}}if(p&&!(l.hasModifier("link")&&f)){this.doc._previewLink(p)}}else if(s()&&t){l.removeModifier("link");l.removeModifier("citation")}this.doc.node.focus();if(t){this.doc.moveCaret(o)}else{this.doc.moveCaret(a[0].first(),a[a.length-1].last())}this.doc.caret.scrollIntoViewIfNeeded()}})});define("qtext2/command/math",["shared/polyfills","qtext2/command/base","qtext2/modifiers"],function D(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/modifiers").canForceModifier;exports.Math=t.extend({exec:function(){this.doc.saveState();if(this.doc.caret.isCollapsed()){this.doc.formattingState.toggleModifier(this.doc.caret,"math")}else{this.doc._toggleMathOrCodeModifier("math");
}return false},shouldExec:function(){var e=this.doc.caret.getCoveringSpans(false);return e.some(function(e){return n(e,"math")})}})});define("qtext2/command/mention",["shared/polyfills","qtext2/command/base","qtext2/constants","settings"],function M(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/constants"),i=require("settings").pageIsMobile;exports.Mention=t.extend({exec:function(e,t){if(!this.doc._shouldAllowLinks()){return}if(this.doc.linkSelector.isActive()){return}if(t=="@"){var r=this.doc.caret.charBefore();if(r&&!n.WORD_START_REGEX.test(r)){return}}this.doc.focus();if(i){this.doc.linkSelector.show(t)}else{var s=this.doc.caret.getAbsolutePosition()||{};this.doc.linkSelector.show(t,s.left,s.top)}return false}})});define("qtext2/command/paste",["shared/polyfills","qtext2/command/base","qtext2/parser","qtext2/constants"],function I(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/parser"),i=require("qtext2/constants").CONTENT_TYPES,r=[i.PUBLIC_HTML,i.HTML,i.TEXT];
exports.Paste=t.extend({exec:function(e,t){if(!t.clipboardData||!t.clipboardData.types||!t.clipboardData.getData){return false}var n=this,i;r.some(function(e){for(var r=0;r<t.clipboardData.types.length;r++){if(t.clipboardData.types[r]==e){i=t.clipboardData.getData(e);if(i){t.stopImmediatePropagation();n.doc.saveState();n._paste(i,e);return true}}}});return false},_paste:function(e,t){var i=n.parse(e,t);i=this.doc.sanitizeContent(i);this.doc._insertSections(i)}})});define("qtext2/command/quote",["shared/polyfills","qtext2/command/base","qtext2/sections/lists"],function A(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/sections/lists").isListSection;exports.Quote=t.extend({exec:function(){var e=this.doc._getSelectedSections(),t=e[0],i=t.isQuoted(),r=[],s,o;this.doc.saveState();while(n(t)){s=t.previousSibling();if(s&&s.getType()==t.getType()){r.push(s);t=s}else{break}}t=e[e.length-1];while(n(t)){o=t.nextSibling();if(o&&o.getType()==t.getType()){r.push(o);t=o;
}else{break}}e=e.concat(r);e.forEach(function(e){e.setQuoted(!i)});return false}})});define("qtext2/command/return",["shared/polyfills","qtext2/command/base","qtext2/sections/plain","qtext2/sections/code"],function P(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/sections/plain").PlainSection,i=require("qtext2/sections/code").CodeSection;exports.Return=t.extend({exec:function(){this.doc.saveState();var e=this._actualReturn();this.doc.updateSpellingSuggestions();this.doc.caret.scrollIntoViewIfNeeded();this.doc.caret.updateAndroidCaretPosition();return e},_actualReturn:function(){var e,t,r,s,o;if(!this.doc.caret.isCollapsed()){this.doc._deleteSelection(false)}e=this.doc.caret.start.span.parent;t=e.previousSibling();r=t&&t.isEmpty();o=this.doc.caret.start.clone();if(!e.isEditable()){s=new n;if(this.doc.caret.start.atSectionStart()){this.doc.insertBefore(s,e)}else{this.doc.insertBefore(s,e.nextSibling());this.doc.moveCaret(s.first())}return false}if(!e.isEmpty()&&e.node.textContent.trim()!==""){
o=e.split(o)}else if(e instanceof i&&t instanceof i&&!r){o=e.split(o)}else if(e instanceof n&&!e.isQuoted()&&e.getIndent()===0){o=e.split(o)}else{e=this.doc.progressivelyExitSection(e);o=e.first()}this.doc.moveCaret(o);this.doc.trigger("command-return");return false}})});define("qtext2/command/soft_return",["shared/polyfills","qtext2/command/base","qtext2/sections/code","qtext2/position"],function k(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/sections/code").CodeSection,i=require("qtext2/position").Position;exports.SoftReturn=t.extend({exec:function(){var e=this.doc.caret.start,t=e.span,r=e.offset,s=t.parent,o=t.getText(),a=this.doc.caret.charBefore()=="\n";if(!s.isEditable()){return this.doc.handleCommand("return")}this.doc.saveState();if(s instanceof n){var d=s.split(e);this.doc.moveCaret(d);return false}if(!s.allowsMultipleSoftReturns()){if(a){while(o.endsWith("\n")){o=o.slice(0,-1)}t.setText(o);return this.doc.handleCommand("return")}}if(e.atSectionEnd()){
t.setText(o+"\n\n");this.doc.moveCaret(t.last())}else{t.setText(o.slice(0,r)+"\n"+o.slice(r));this.doc.moveCaret(new i(t,r+1))}this.doc.moveCaret(new i(t,r+1));return false}})});define("qtext2/command/undoredo",["shared/polyfills","qtext2/command/base","qtext2/util"],function L(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/util").Util;exports.UndoRedo=t.extend({exec:function(e){if(e=="undo"){return this._undo()}else{return this._redo()}},_undo:function(){if(!this.doc.undoManager.canRedo()){if(!n.jsonEqual(this.doc.toJSON(),this.doc.undoManager.state())){this.doc.saveState()}}this.doc.undoManager.undo();this.doc.fromJSON(this.doc.undoManager.state());return false},_redo:function(){this.doc.undoManager.redo();this.doc.fromJSON(this.doc.undoManager.state());return false}})});define("qtext2/command/video",["shared/polyfills","qtext2/command/base","qtext2/sections/embed"],function B(require,exports,e){var t=require("qtext2/command/base").Command,n=require("qtext2/sections/embed").EmbedSection;
exports.Video=t.extend({exec:function(e,t){t.forEach(function(e,i){var r=n.fromOtherSection(e);if(r!==null){t[i]=r}})}})});define("qtext2/commands",["shared/polyfills","qtext2/command/base","qtext2/command/backspace","qtext2/command/code","qtext2/command/copy","qtext2/command/delete","qtext2/command/indent","qtext2/command/image","qtext2/command/link","qtext2/command/math","qtext2/command/mention","qtext2/command/paste","qtext2/command/quote","qtext2/command/return","qtext2/command/soft_return","qtext2/command/undoredo","qtext2/command/video","qtext2/sections/lists"],function U(require,exports,e){var t=require("qtext2/command/base"),n=require("qtext2/command/backspace").Backspace,i=require("qtext2/command/code").Code,r=require("qtext2/command/copy").Copy,s=require("qtext2/command/delete").Delete,o=require("qtext2/command/indent").Indent,a=require("qtext2/command/image").Image,d=require("qtext2/command/link").Link,c=require("qtext2/command/math").Math,l=require("qtext2/command/mention").Mention,f=require("qtext2/command/paste").Paste,h=require("qtext2/command/quote").Quote,u=require("qtext2/command/return").Return,p=require("qtext2/command/soft_return").SoftReturn,g=require("qtext2/command/undoredo").UndoRedo,m=require("qtext2/command/video").Video,v=require("qtext2/sections/lists").OrderedListSection,x=require("qtext2/sections/lists").UnorderedListSection;
exports.COMMANDS={backspace:n,cite:d,code:i,copy:r,cut:r,deindent:o,"delete":s,"delete-backward":s,"delete-forward":s,"delete-next-word":s,"delete-previous-word":s,indent:o,image:a,link:d,math:c,mention:l,paste:f,quote:h,redo:g,"return":u,"soft-return":p,undo:g,video:m,bold:t.spanModifierToggle("bold"),italic:t.spanModifierToggle("italic"),ordered_list:t.sectionTypeToggle(v),unordered_list:t.sectionTypeToggle(x),space:t.eventProxy("command-space")}});define("qtext2/extension/tooltips",["shared/polyfills","qtext2/extension/base","qtext2/util","qtext2/tooltip"],function H(require,exports,e){var t=require("qtext2/extension/base").Extension,n=require("qtext2/util").Util,i=require("qtext2/tooltip");exports.Tooltips=t.extend({install:function(){this._activeLinkSpan=null;this.doc.on("caretMoved",this.onCaretMoved.bind(this));this.doc.on("blur",this.onDocBlur.bind(this))},destroy:function(){this._hideTooltip()},onDocBlur:function(){this._hideTooltip()},onCaretMoved:function(){this._maybeShowTooltip();
},_maybeShowTooltip:function(){if(this._shouldShowTooltip()){this._showTooltip()}else{this._hideTooltip()}},_shouldShowTooltip:function(){var e=this.doc.caret.start.span;return e.hasModifier("link")||e.hasModifier("citation")},_showTooltip:function(){var e=this.doc.caret.start.span,t,r;if(e.hasModifier("link")){r=e.getModifier("link")}else if(e.hasModifier("citation")){t=e.getModifier("citation");r=t.target}if(!(r&&r.url)){return}if(this._activeLinkSpan===e){return}this._activeLinkSpan=e;var s=n.create("a");s.target="_blank";s.rel="noreferrer nofollow";s.href=r.url;s.textContent=r.url;i.show(e.node,s)},_hideTooltip:function(){this._activeLinkSpan=null;i.hide()}})});define("qtext2/extension/autolist",["shared/polyfills","qtext2/extension/base","qtext2/position","qtext2/sections/plain","qtext2/sections/lists","qtext2/constants"],function F(require,exports,e){var t=require("qtext2/extension/base").Extension,n=require("qtext2/position").Position,i=require("qtext2/sections/plain").PlainSection,r=require("qtext2/sections/lists").UnorderedListSection,s=require("qtext2/sections/lists").OrderedListSection,o=require("qtext2/constants");
exports.Autolist=t.extend({install:function(){this.doc.on("command-space",this.onSpace.bind(this))},onSpace:function(){if(!this.shouldAutoList()){return}var e=this.doc.caret.start.clone();var t=e.span;var i=t.parent;var a=e.offset;var d=t.getText();var c=d.slice(0,a);var l=new RegExp("^([-*+]|--|"+o.EM_DASH+")$");var f=/^1[.)]$/;if(i.firstChild()!=t){return}if(!(l.test(c)||f.test(c))){return}var h=l.exec(c)||f.exec(c);h=h[0];t.setText(d.slice(0,h.length)+" "+d.slice(h.length));this.doc.moveCaret(new n(t,h.length+1));this.doc.saveState();if(l.test(c)){this.doc.toggleSectionType(r)}else{this.doc.toggleSectionType(s)}t.setText(d.slice(h.length));if(t.getText()===""&&!t.nextSibling()){t.setPlaceholder()}this.doc.moveCaret(t.first(),null,true);return false},shouldAutoList:function(){if(this.doc.isDisabledCommand("ordered_list")||this.doc.isDisabledCommand("unordered_list")){return false}var e=this.doc.caret.isCollapsed(),t=this.doc.caret.start.span,n=t.parent;if(!e){return false}if(t.hasModifier("link")||t.hasModifier("math")||t.hasModifier("code")){
return false}return n instanceof i}})});define("qtext2/extension/autolink",["shared/polyfills","qtext2/extension/base","qtext2/span","qtext2/util","qtext2/position"],function Q(require,exports,e){var t=require("qtext2/extension/base").Extension,n=require("qtext2/span").Span,i=require("qtext2/util").Util,r=require("qtext2/position").Position;exports.Autolink=t.extend({install:function(){this.doc.on("command-space",this.onSpace.bind(this));this.doc.on("command-return",this.onReturn.bind(this))},onSpace:function(){return this.detectLinksBeforeCaret()},onReturn:function(){return this.detectLinksBeforeCaret(true)},detectLinksBeforeCaret:function(e){var t=this.doc.caret.start,n=t.span;if(e&&t.atSectionStart()){n=n.previous();if(!n){return false}t=n.last()}return!this._detectLinks(n,t,!e)},_detectLinks:function(e,t,s){if(!this.doc._shouldAllowLinks(e)){return false}var o=e.parent,a=t||e.last(),d=a.offset,c=a.previousWordBoundary(/\s/),l=e.getText(),f=l.slice(c.offset,d),h=i.linkify(f),u;h.forEach(function(e){
var t=e.text,i=e.href;if(i&&t==f){u=new n(f,{link:{type:"url",url:i}})}else{f=f.slice(t.length)}});if(!u){return false}if(s){e.setText(l.slice(0,d)+" "+l.slice(d));this.doc.moveCaret(new r(e,d+1))}this.doc.saveState();c=new r(a.span,d-f.length);var p=e,g,m;if(c.equals(e.first())&&a.equals(e.last())){if(s){p.setText(" ");m=new r(p,1)}else{p=null}}else{if(!c.equals(e.first())){g=new n(e.getText().slice(0,c.offset),e.modifiers)}if(s){p.setText(" "+p.getText().slice(a.offset));m=new r(p,1)}else if(!a.equals(e.last())){p.setText(p.getText().slice(a.offset))}else{p=null}}if(g){o.insertBefore(g,e)}o.insertBefore(u,e);if(!p){o.removeChild(e)}if(m&&s){this.doc.moveCaret(m)}this.doc._previewLink(u);return true}})});define("qtext2/extension/typing_change_base",["shared/polyfills","qtext2/extension/base","qtext2/sections/code"],function V(require,exports,e){var t=require("qtext2/extension/base").Extension,n=require("qtext2/sections/code").CodeSection;exports.TypingExtension=t.extend({install:function(){},
isActive:function(e){if(!e){e=this.doc.caret.selection}var t=e.start.span.parent;if(t instanceof n){return false}if(e.getCoveringSpans().some(function(e){return e.hasModifier("code")||e.hasModifier("math")})){return false}if(this.doc.formattingState.is("code")||this.doc.formattingState.is("math")){return false}return true}})});define("qtext2/extension/ellipses",["shared/polyfills","qtext2/extension/typing_change_base","qtext2/selection","qtext2/constants"],function W(require,exports,e){var t=require("qtext2/extension/typing_change_base").TypingExtension,n=require("qtext2/selection").Selection,i=require("qtext2/constants").ELLIPSIS;exports.Ellipses=t.extend({install:function(){this.doc.on("keypress",this.onKeypress.bind(this))},onKeypress:function(e,t){if(t!="."){return}if(!this.isActive()){return}var r=this.doc.caret.start.prevPositionInSection(2);if(!r){return}var s=new n(r,this.doc.caret.start);if(!this.isActive(s)){return}if(s.getText()!=".."){return}var o=s.start.span.parent;o.deleteText(s.start,s.end);
s.start.span.insertText(i,s.start.offset);this.doc.moveCaret(s.start.nextPositionInSection());this.doc.caret.updateAndroidCaretPosition();this.doc.saveState();return false}})});define("qtext2/extension/hr",["shared/polyfills","qtext2/extension/base","qtext2/sections/plain","qtext2/sections/horizontal_rule","qtext2/constants"],function j(require,exports,e){var t=require("qtext2/extension/base").Extension,n=require("qtext2/sections/plain").PlainSection,i=require("qtext2/sections/horizontal_rule").HorizontalRuleSection,r=require("qtext2/constants");exports.HR=t.extend({install:function(){this.doc.on("command-return",this.onReturn.bind(this))},onReturn:function(){if(!this.isActive()){return}var e=new RegExp("^([-*+_=]{3,}|["+r.EM_DASH+"-]{2,})$"),t=this.doc.caret.start.clone(),s=t.span,o=s.parent,a=o.previousSibling();if(!a){return}if(a instanceof n&&e.test(a.getText().trim())&&!a.isQuoted()){this.doc.insertBefore(new i,a);this.doc.removeChild(a)}},isActive:function(){return!this.doc.isDisabledCommand("horizontal-rule");
}})});define("qtext2/extension/undo_state",["shared/polyfills","qtext2/extension/base"],function Y(require,exports,e){var t=require("qtext2/extension/base").Extension;exports.UndoState=t.extend({install:function(){this.doc.on("keypress",this.onKeypress.bind(this))},onKeypress:function(e,t){if(t=="."||t==","){this.doc.saveState()}}})});define("qtext2/extension/mention",["shared/polyfills","qtext2/extension/base"],function z(require,exports,e){var t=require("qtext2/extension/base").Extension;exports.Mention=t.extend({install:function(){this.doc.on("keypress",this.onKeypress.bind(this))},onKeypress:function(e,t){if(t=="@"){this.doc.handleCommand("mention",t)}}})});define("qtext2/extension/non_editable_cursors",["shared/polyfills","qtext2/extension/base","qtext2/section"],function X(require,exports,e){var t=require("qtext2/extension/base").Extension,n=require("qtext2/section").Section;exports.NonEditableCursors=t.extend({install:function(){this.doc.on("mousedown",this.onMousedown.bind(this));
this.doc.on("longpress",this.onLongpress.bind(this))},onLongpress:function(e,t){var n=this._sectionFromNode(t.target);if(!n){return}if(n.isEditable()){return}this.doc.moveCaret(n.first(),n.last());this.doc.updateCaret()},onMousedown:function(e,t){var n=this._sectionFromNode(t.target);if(!n){return}if(n.isEditable()){return}var i=t.target.getBoundingClientRect();var r=i.left+document.body.scrollLeft;var s=t.pageX-r;if(t.target.width/2>s){this.doc.moveCaret(n.first())}else{this.doc.moveCaret(n.last())}this.doc.updateCaret()},_sectionFromNode:function(e){var t=e;while(t){if(n.is(t)){return n.get(t)}t=t.parentElement}return null}})});define("qtext2/extension/smart_quotes",["shared/polyfills","qtext2/extension/typing_change_base","qtext2/position","qtext2/selection","qtext2/constants"],function J(require,exports,e){var t=require("qtext2/extension/typing_change_base").TypingExtension,n=require("qtext2/position").Position,i=require("qtext2/selection").Selection,r=require("qtext2/constants");exports.SmartQuotes=t.extend({
install:function(){this.initializeConstants();this.doc.on("keypress",this.onKeypress.bind(this));this.doc.on("command-space",this.onSpace.bind(this))},onSpace:function(){if(!this.isActive()){return}var e=this.doc.caret.start.previousWordBoundary(/\s/),t=e.charAfter(),n=this.doc.caret.start;if(t!==null&&e.atSpanEnd()){e=e.span.nextSibling().first()}if(t===r.OPEN_SINGLE_QUOTE){var i=this.doc.caret.previousTextUntil(e).slice(1);if(this.frontApostropheRegex.test(i)){var s=e.span.getText();e.span.setText(s.slice(0,e.offset)+r.CLOSE_SINGLE_QUOTE+s.slice(e.offset+1));this.doc.moveCaret(n)}}},onKeypress:function(e,t){if(!this.isActive()){return}if(t=="'"){this.handleSingleQuote();this.doc.updateSpellingSuggestions();return false}if(t=='"'){this.handleDoubleQuote();this.doc.updateSpellingSuggestions();return false}if(t.toUpperCase()=="S"){if(this.doc.caret.start.charBefore()==r.SINGLE_PRIME){var n=this.doc.caret.start.prevPositionInSection(),i=this.doc.caret.start.span.parent;i.deleteText(n,this.doc.caret.start);
n.span.insertText(r.CLOSE_SINGLE_QUOTE,n.offset);this.doc.moveCaret(n.nextPositionInSection());this.doc.updateSpellingSuggestions();return}}},handleSingleQuote:function(){var e=this.doc.caret.charBefore(),t=r.CLOSE_SINGLE_QUOTE,n=this.doc.caret,s=n.start.span.parent,o=new i(s.first(),n.start);if(e===null||r.WORD_START_REGEX.test(e)){t=r.OPEN_SINGLE_QUOTE}else if(this.primeRegex.test(e)){if(!this.unclosedSingleQuoteRegex.test(o.getText())){t=r.SINGLE_PRIME}}this.insertChar(t)},handleDoubleQuote:function(){var e=this.doc.caret.charBefore(),t=r.CLOSE_DOUBLE_QUOTE,n=this.doc.caret,s=n.start.span.parent,o=new i(s.first(),n.start);if(e===null||/\s|[({[]/.test(e)){t=r.OPEN_DOUBLE_QUOTE}else if(this.primeRegex.test(e)){if(!this.unclosedDoubleQuoteRegex.test(o.getText())){t=r.DOUBLE_PRIME}}this.insertChar(t)},insertChar:function(e){var t=this.doc.caret.start,i=t.span,r=i.getText(),s=t.offset;i.setText(r.slice(0,s)+e+r.slice(s));this.doc.moveCaret(new n(i,s+1))},initializeConstants:function(){var e=Object.keys(r.FRACTIONS).join("");
this.primeRegex=new RegExp("\\d|["+e+"]");var t=["bout","cause","course","d","e_ll","em","er","ere","e_s","fraid","fro","kay","lo","m","n","n_","pon","round","sblood","scuse","sfar","sfoot","sup","t","taint","tain_t","til","tis","tisn_t","tshall","twas","twasn_t","tween","twere","tweren_t","twill","twixt","twon_t","twou_d","twou_dn_t","twould","twouldn_t","um","ve"];var n="['‘’′]";var i="";for(var s=0;s<t.length;++s){i+="|"+t[s].replace(/_/g,n)}this.frontApostropheRegex=new RegExp("^(\\d\\ds?"+i+")$","i");this.unclosedSingleQuoteRegex=new RegExp(r.OPEN_SINGLE_QUOTE+"[^"+r.CLOSE_SINGLE_QUOTE+"]*$");this.unclosedDoubleQuoteRegex=new RegExp(r.OPEN_DOUBLE_QUOTE+"[^"+r.CLOSE_DOUBLE_QUOTE+"]*$")}})});define("qtext2/extension/double_space",["shared/polyfills","qtext2/extension/typing_change_base","qtext2/selection"],function G(require,exports,e){var t=require("qtext2/extension/typing_change_base").TypingExtension,n=require("qtext2/selection").Selection;exports.DoubleSpace=t.extend({install:function(){
this.doc.on("command-space",this.onSpace.bind(this));this.MAX_SPACES=2;this.spacesExp=new RegExp("\\s{"+this.MAX_SPACES+"}")},onSpace:function(){if(!this.isActive()){return}var e=this.doc.caret,t=e.start.prevPositionInSection(this.MAX_SPACES)||e.start.span.parent.first(),i=new n(t,e.start),r=e.start.nextPositionInSection(this.MAX_SPACES)||e.start.span.parent.last(),s=new n(e.start,r),o=e.start.nextPositionInSection(),a=i.getText(),d=s.getText(),c=e.charAfter();if(/\s/.test(c)&&c!="\n"&&o&&!o.span.hasModifier("citation")&&this.spacesExp.test(a+d)){this.doc.moveCaret(o);this.doc.caret.updateAndroidCaretPosition();return false}if(this.spacesExp.test(a)){this.doc.caret.updateAndroidCaretPosition();return false}return}})});define("qtext2/extension/dashes",["shared/polyfills","qtext2/extension/typing_change_base","qtext2/position","qtext2/selection","qtext2/constants"],function K(require,exports,e){var t=require("qtext2/extension/typing_change_base").TypingExtension,n=require("qtext2/position").Position,i=require("qtext2/selection").Selection,r=require("qtext2/constants");
exports.Dashes=t.extend({install:function(){this.doc.on("keypress",this.onKeypress.bind(this))},onKeypress:function(e,t){var s=this.doc.caret.start;var o=s.span;var a=o.parent;if(s.atSpanStart()){o=o.previousSibling();if(!o){return}s=o.last()}var d=s.offset;var c=s.prevPositionInSection();if(!c){return}var l=Object.keys(r.FRACTIONS).join("");var f=new RegExp("(\\d|["+l+"])[-"+r.EM_DASH+"]");if(/\d/.test(t)){var h=c.prevPositionInSection();if(!h){return}var u=new i(h,this.doc.caret.start);if(!this.isActive(u)){return}if(f.test(u.getText())){a.deleteText(c,this.doc.caret.start);c.span.insertText(r.EN_DASH,c.offset);this.doc.moveCaret(new n(o,d))}return}if(t=="-"){if(!this.isActive(new i(c,this.doc.caret.start))){return}if(this.doc.caret.charBefore()=="-"){a.deleteText(c,this.doc.caret.start);c.span.insertText(r.EM_DASH,c.offset);this.doc.moveCaret(new n(o,d));this.doc.caret.updateAndroidCaretPosition();return false}return}}})});define("qtext2/extension/arrows",["shared/polyfills","qtext2/extension/typing_change_base","qtext2/position","qtext2/selection","qtext2/constants"],function Z(require,exports,e){
var t=require("qtext2/extension/typing_change_base").TypingExtension,n=require("qtext2/position").Position,i=require("qtext2/selection").Selection,r=require("qtext2/constants");exports.Arrows=t.extend({install:function(){this.doc.on("keypress",this.onKeypress.bind(this))},onKeypress:function(e,t){if(!this.isActive()){return}var s=this.doc.caret.start.span,o=s.parent,a=this.doc.caret.start.offset,d;var c=this.doc.caret.start.prevPositionInSection();if(!c){return}if(t==">"){d=new i(c,this.doc.caret.start);if(!this.isActive(d)){return}if(d.getText()==r.EM_DASH){o.deleteText(c,this.doc.caret.start);c.span.insertText(r.RIGHT_ARROW,c.offset);this.doc.moveCaret(new n(s,a));this.doc.caret.updateAndroidCaretPosition();return false}return}if(t=="-"){var l=c.prevPositionInSection();if(!l){return}d=new i(l,this.doc.caret.start);if(!this.isActive(d)){return}var f=d.getText();if(f=="<"+r.EM_DASH||f=="<-"){o.deleteText(d.start,d.end);d.start.span.insertText(r.LEFT_ARROW,d.start.offset);this.doc.moveCaret(this.doc.caret.start.prevPositionInSection());
this.doc.caret.updateAndroidCaretPosition();return false}}}})});define("qtext2/extensions",["shared/polyfills","qtext2/extension/tooltips","qtext2/extension/autolist","qtext2/extension/autolink","qtext2/extension/ellipses","qtext2/extension/hr","qtext2/extension/undo_state","qtext2/extension/mention","qtext2/extension/non_editable_cursors","qtext2/extension/smart_quotes","qtext2/extension/double_space","qtext2/extension/dashes","qtext2/extension/link_interaction","qtext2/extension/arrows"],function ee(require,exports,e){var t=require("qtext2/extension/tooltips").Tooltips,n=require("qtext2/extension/autolist").Autolist,i=require("qtext2/extension/autolink").Autolink,r=require("qtext2/extension/ellipses").Ellipses,s=require("qtext2/extension/hr").HR,o=require("qtext2/extension/undo_state").UndoState,a=require("qtext2/extension/mention").Mention,d=require("qtext2/extension/non_editable_cursors").NonEditableCursors,c=require("qtext2/extension/smart_quotes").SmartQuotes,l=require("qtext2/extension/double_space").DoubleSpace,f=require("qtext2/extension/dashes").Dashes,h=require("qtext2/extension/link_interaction").LinkInteraction,u=require("qtext2/extension/arrows").Arrows;
exports.EXTENSIONS=[s,t,i,n,r,o,a,d,c,l,f,h,u]});define("qtext2/base",["shared/polyfills","shared/rangy","shared/browser","qtext2/constants","shared/log","qtext2/util","shared/util","qtext2/container","qtext2/position","qtext2/span","qtext2/quirks","shared/email","qtext2/undo","interface/settings","qtext2/keys","qtext2/shortcuts","qtext2/section","qtext2/sections/plain","qtext2/sections/lists","qtext2/sections/code","qtext2/sections/image","qtext2/sections/horizontal_rule","qtext2/formatting_state","qtext2/caret","qtext2/sections/embed","shared/client","qtext2/modifiers","qtext2/mutations","qtext2/parser","qtext2/commands","qtext2/extensions"],function te(require,exports,e){var t=require("shared/rangy"),n=require("shared/browser"),i=require("qtext2/constants").CONTENT_TYPES,r=require("shared/log").log,s=require("qtext2/util").Util,o=require("shared/util").extend,a=require("qtext2/container").Container,d=require("qtext2/position").Position,c=require("qtext2/span").Span,l=require("qtext2/quirks").Quirks,f=require("shared/email").isValidEmail,h=require("qtext2/undo").UndoManager,u=require("interface/settings").pageIsMobile,p=require("qtext2/keys"),g=require("qtext2/shortcuts").SHORTCUTS,m=require("qtext2/section"),v=m.Section,x=require("qtext2/sections/plain").PlainSection,C=require("qtext2/sections/lists").UnorderedListSection,S=require("qtext2/sections/lists").OrderedListSection,b=require("qtext2/sections/code").CodeSection,E=require("qtext2/sections/image").ImageSection,_=require("qtext2/sections/horizontal_rule").HorizontalRuleSection,y=require("qtext2/formatting_state").FormattingState,w=require("qtext2/caret").Caret,T=require("qtext2/sections/embed").EmbedSection,N=require("shared/client"),q=require("qtext2/modifiers").canSetModifier,R;
if(u){R=require("mobile_app2/messages")}r=r.bind(r,"qtext2");var O=a.create("doc",{init:function(e){t.rangy.init();this.disabledCommands=[];this.fromJSON(e);this._listeners={};this.node.setAttribute("contenteditable","true");this._attachEventListeners();this._commands={};this._attachCommands();this._extensions=[];this._initExtensions();var n=require("qtext2/mutations").MutationFixer;this.mutationFixer=new n(this);var i=this.firstChild().firstChild();this.caret=new w(i.first(),i.first(),this);this.formattingState=new y(this.caret);this.undoManager=new h(e);this.linkSelector=null;this.imageUploader=null;this.photoSearch=null;this._backspaceCount=0;this._runForever(this._updatePlaceholder.bind(this));this.linkInputFocus=true},setLinkInputFocus:function(e){this.linkInputFocus=e},destroy:function(){this._destroyed=true;s.safeRemoveChild(this.node,this.node.parentElement);this._extensions.forEach(function(e){e.destroy()})},contains:function(e){return this.node.contains(e)},isEmpty:function(){
return this.children.length==1&&this.children[0].isEmpty()},isOnlyWhiteSpace:function(){return this.children.every(function(e){return e.isOnlyWhiteSpace()})},getLength:function(){var e=0;this.children.forEach(function(t){e+=t.getLength()});return e},disableCommands:function(e){this.disabledCommands=e||[]},isDisabledCommand:function(e){return this.disabledCommands.indexOf(e)!=-1},allowsMultipleSections:function(){return!this.isDisabledCommand("return")},disable:function(){this.node.removeAttribute("contenteditable")},enable:function(){this.node.setAttribute("contenteditable","true")},focus:function(){if(!this.node){return}var e=window.scrollX,t=window.scrollY;this.node.focus();window.scrollTo(e,t);this.moveCaret(this.caret.start,this.caret.end,true)},clear:function(){this.fromJSON({})},forceDomReflow:function(){this.fromJSON(this.toJSON())},toJSON:function(){var e={sections:[],caret:this.caret.toJSON()};this.children.forEach(function(t){e.sections.push(t.toJSON())});return s.removeNullValues(e);
},fromJSON:function(e){var t,n,i=this;this.removeChildren();if(e.sections&&e.sections.length){e.sections.forEach(function(e){i.appendChild(v.fromJSON(e))})}else{this.appendChild(new x)}if(e.caret){t=e.caret.start;n=e.caret.end;this.moveCaret(new d(this.children[t.sectionIdx].children[t.spanIdx],t.offset),new d(this.children[n.sectionIdx].children[n.spanIdx],n.offset))}else{this.caret=new w(this.lastChild().last(),this.lastChild().last(),this)}},hasChanged:function(e){var t=this.toJSON();return!s.jsonEqual(t.sections,e.sections)},on:function(e,t){this._listeners[e]=this._listeners[e]||[];this._listeners[e].push(t)},trigger:function(e){if(!(e in this._listeners)){return null}var t=this._listeners[e],n=false,i,r,s,o=new Array(arguments.length);o[0]=n;for(i=1;i<arguments.length;++i){o[i]=arguments[i]}for(i=0;i<t.length;i++){r=t[i];o[0]=n;s=r.apply(r,o);if(s===false){n=true}}return n?false:null},getToolbarState:function(e){var t=this,n=this.caret.start.span,i=n.parent,r=this.caret.isCollapsed()&&this.caret.hasCharBefore(),s=this.formattingState.is("bold"),o=this.formattingState.is("italic"),a=this.formattingState.is("link"),d=this.formattingState.is("math"),c=this.formattingState.is("code")||i instanceof b,l=i instanceof S,f=i instanceof C,h=l||f,p=n.isEditable(),g=c||d||!p,m=!this.undoManager.canUndo(),v=!this.undoManager.canRedo(),x;
if(N.isAndroid()){g=r||g}if(e===0){x=[{name:"link_input",focused:this.linkInputFocus},{name:"space"},{name:"cite"},{name:"link_save"}]}else if(e===1){x=[{name:"bold",pressed:s,disabled:g},{name:"italic",pressed:o,disabled:g},{name:"ordered_list",pressed:l,disabled:!p},{name:"unordered_list",pressed:f,disabled:!p}];if(h){x=x.concat([{name:"indent"},{name:"deindent"}])}x.push({name:"space"});if(!(u&&h)){x.push({name:"image"})}x=x.concat([{name:"link",pressed:a,disabled:g},{name:"overflow_show",grayBackground:true}])}else if(e===2){x=[{name:"mention",disabled:a||c||d||!p},{name:"quote",pressed:i.isQuoted()},{name:"code",pressed:c,disabled:!p},{name:"math",pressed:d,disabled:!p},{name:"space"},{name:"undo",disabled:m},{name:"redo",disabled:v},{name:"overflow_hide"}]}x.forEach(function(e){if(t.isDisabledCommand(e.name)){e.pressed=false;e.disabled=true}});return x},updateSpellingSuggestions:function(){if(N.isIOSApp()){setTimeout(function(){R.send("selectionChanged")},0)}},handleCommand:function(e){
var t=this,i=e,r=new Array(arguments.length-1),s;for(var o=1;o<arguments.length;++o){r[o-1]=arguments[o]}if(this.isDisabledCommand(i)){return false}if(n.ios&&t._backspaceCount>20&&i=="backspace"){i="delete-previous-word"}if(i in this._commands){s=this._commands[i];return s.run.apply(s,[i].concat(r))}},progressivelyExitSection:function(e,t){if(e.getIndent()>0){e.setIndent(e.getIndent()-1)}else if(!(e instanceof x)&&!t){e=e.changeType(x);var n=e.previousSibling();while(n&&n.isEditable()&&(n.isEmpty()||n.node.textContent.trim()==="")){var i=n;n=n.previousSibling();this.removeChild(i)}}else if(e.isQuoted()){e.setQuoted(false)}return e},toggleModifier:function(e){var t,n;this.formattingState.toggleModifier(this.caret,e);if(this.caret.isCollapsed()){return false}t=this._getSelectedSpans(false);n=t[0].getModifier(e);t.forEach(function(t){if(!t.isEditable()){return}if(n){t.removeModifier(e)}else{t.setModifier(e,true)}});return false},toggleSectionType:function(e){var t=this._getSelectedSections(),n=t[0]instanceof e,i=this.caret.start.clone(),r=this.caret.end.clone();
t.forEach(function(t){if(t.isEditable()){if(n){t.changeType(x)}else{t.changeType(e)}}});this.moveCaret(i,r);if(!n&&t.length>1){this.forceDomReflow()}return false},cloneSelection:function(){var e=this,t=this._getSelectedSpans(false),n=[],i,r;t.forEach(function(t){if(i!=t.parent){i=t.parent;r=t.parent.toJSON();r.spans=[];if(!e.caret.containsEntireSection(i)){r.type="plain"}n.push(r)}r.spans.push(t.toJSON())});return n.map(function(e){return v.fromJSON(e)})},sanitizeContent:function(e){var t=this;var n=e.filter(function(e){if(e instanceof E&&t.isDisabledCommand("image")){return false}if(e instanceof T&&t.isDisabledCommand("video")){return false}if(e instanceof _&&t.isDisabledCommand("horizontal-rule")){return false}return true});if(!t.allowsMultipleSections()&&e.length>0){n=[n.reduce(function(e,t){e.merge(t);return e})]}n=n.map(function(e){var n=e instanceof b&&t.isDisabledCommand("code");n=n||e instanceof C&&t.isDisabledCommand("unordered_list");n=n||e instanceof S&&t.isDisabledCommand("ordered_list");
if(n){e=e.changeType(x)}e.setQuoted(e.isQuoted()&&!t.isDisabledCommand("quote"));e.children.forEach(function(e){for(var n in e.modifiers){if(t.isDisabledCommand(n)){e.removeModifier(n)}}});return e});return n},saveState:function(){this.undoManager.add(this.toJSON());this.trigger("meaningfulChange")},setImageUploader:function(e){this.imageUploader=e},setLinkSelector:function(e){var t=this;t.linkSelector=e;e.onSubmit(function(n){var i=t._insertOrModifyLink(n.text,n.target||{type:"url",url:n.url});e.hide();t.focus();t.moveCaret(i.nextSibling().last());setTimeout(function(){t.focus();t.caret.scrollIntoViewIfNeeded()},0);t.saveState()});e.onCancel(function(n){e.hide();t.focus();if(n){var i=t.caret.start.span.modifiers,r=new c(n,i);t.insertSpan(t.caret.start,r);t.moveCaret(r.last())}})},setPhotoSearch:function(e){var t=this;t.photoSearch=e;e.onInsert(function(n){t.handleCommand("image",[n]);e.hide();t.focus()});e.onCancel(function(){e.hide();t.focus()})},detectLinksInSection:function(e){var t=this;
e.children.forEach(function(n){if(!q(n,"link")||n.hasModifier("link")){return}var i=s.linkify(n.getText());if(i.length===0||i.length==1&&!i[0].href){return}var r=n.modifiers;i.forEach(function(i){var s=i.text,o=i.href,a=new c(s,r);if(o){a.setModifier("link",{type:"url",url:o},true);t._previewLink(a)}e.insertBefore(a,n)});e.removeChild(n)})},uploadImageUrl:function(e,t){var n=this;this.imageUploader.showUploading();this.imageUploader.uploadImageUrl(e,function(e){if(t.previousSibling()){n.moveCaret(t.previousSibling().last())}else if(t.nextSibling()){n.moveCaret(t.nextSibling().first())}else{t.parent.insertBefore(new c(" "),t);n.moveCaret(t.previousSibling().first())}t.parent.removeChild(t);n.insertImages([e]);n.imageUploader.hideDropZone()})},insertSpan:function(e,t){var n;if(e.atSpanStart()){n=e.span}else if(e.atSpanEnd()){n=e.span.nextSibling()}else{n=e.span.split(e.offset)}e.span.parent.insertBefore(t,n);if(e.span.getText()===""){e.span.parent.removeChild(e.span)}return t.last()},insertImages:function(e){
this.handleCommand("image",e)},moveCaret:function(e,t,n){var i=this.caret.move(e,t,n);this.trigger("caretMoved");return i},moveCaretEnd:function(e){var t=this.caret.moveEnd(e);this.trigger("caretMoved");return t},moveCaretStart:function(e){var t=this.caret.moveStart(e);this.trigger("caretMoved");return t},_updatePlaceholder:function(){var e=this.isEmpty()&&this.children[0]instanceof x&&!this.children[0].isQuoted();if(e){this.node.classList.add("empty")}else{this.node.classList.remove("empty")}},_handleEmptySpan:function(e,t){var n,i,r;if(e.parent.firstChild()==e&&e.parent.children.length==1){e.setPlaceholder();return e.first()}i=e.previousSibling();r=e.nextSibling();e.parent.removeChild(e);if(t){if(i){e=i;n=i.getLength()}else{e=r;n=0}}else{if(r){e=r;n=0}else{e=i;n=i.getLength()}}return new d(e,n)},updateCaret:function(){var e=this.caret.update();if(e){this.trigger("caretMoved");this.trigger("meaningfulChange")}this._updateActiveSpans();return e},_updateCaretAndFormattingState:function(){
var e=this.updateCaret();if(e){this._updateFormattingState()}},_updateActiveSpans:function(){var e=this.node.querySelectorAll(".active"),t=this.caret.start.span,n=this.caret.end.span,i,r;for(i=0;i<e.length;i++){e[i].classList.remove("active")}for(r=t;r!=n;r=r.next()){r.node.classList.add("active")}r.node.classList.add("active")},_debugEvent:function(e,t){r(e,t.which,t,this.caret)},_attachEventListeners:function(){var e=this,t=this._debugEvent.bind(this),i=new p.Hub(this.node),r,o,a;for(o in g){a=g[o];i.on(o,this.handleCommand.bind(this,a))}["Left","Up","Home"].forEach(function(t){i.on(t,function(){return!(e.caret.isCollapsed()&&e.caret.start.atDocStart())})});["Right","Down","End"].forEach(function(t){i.on(t,function(){return!(e.caret.isCollapsed()&&e.caret.start.atDocEnd())})});s.on("keydown",this.node,function(s){t("keydown",s);var o;if(!(p.isNavigation(s)&&!e.caret.isCollapsed())){e.updateCaret()}if(!p.isOnlyShiftKey(s)){e.caret.scrollIntoViewIfNeeded()}if(n.ios){if(s.which===8){e._backspaceCount+=1;
}else{e._backspaceCount=0}if(r<+new Date-500){e._backspaceCount=0}}o=i.trigger(s);e.trigger("keydown");setTimeout(e.trigger.bind(e,"meaningfulChange"),0);return o});s.on("keypress",this.node,function(n){t("keypress",n);e.updateCaret();if(n&&n.which!==0&&!n.ctrlKey&&!n.metaKey&&!n.altKey){e._beforeTextInput(n)}if(String.fromCharCode(n.which)=="@"){return e.handleCommand("mention","@")}var i=String.fromCharCode(n.which);return e.trigger("keypress",i)});s.on("keyup",this.node,function(i){t("keyup",i);if(e.caret.isCollapsed()||!p.isNavigation(i)||!i.shiftKey||p.isOnlyShiftKey(i)){e.updateCaret()}if(n.ios){r=+new Date}if(p.isNavigation(i)||!e.caret.isCollapsed()){e._updateFormattingState()}else{e._afterTextInput()}return false});s.on("compositionstart",this.node,function(e){t("compositionstart",e)});s.on(["textInput","compositionupdate"],this.node,function(i,r){t(r,i);if(!N.isAndroid()){e.updateCaret()}e._beforeTextInput(i);if(r=="textInput"&&l.usesCompositionEvents()){return true}if(r=="compositionupdate"&&!l.usesCompositionEvents()){
return true}if(!e.caret.isCollapsed()){return true}var s=e.caret.start.span;var o=i.data;if(o==" "&&e.handleCommand("space")===false||e.trigger("keypress",o)===false){return false}if(o.endsWith("\n")){i.preventDefault();var a=s.getText();var c=e.caret.start.offset;var f=c+o.length-1;var h=[a.slice(0,c),o.slice(0,o.length-1),a.slice(c)].join("");s.setText(h);e.moveCaret(new d(s,f));e.handleCommand("return");return false}if(s.isEmpty()){if(n.msedge){return}s.setText(" ");e.moveCaret(s.first(),null,true)}setTimeout(function(){e.updateCaret();e._afterTextInput()},0)});s.on("compositionend",this.node,function(e){t("compositionend",e)});s.on("focus",this.node,function(){if(e.linkSelector){e.linkSelector.hide()}if(e.photoSearch){e.photoSearch.hide()}e.trigger("focus")});s.on("blur",this.node,function(){e.trigger("blur")});if(n.mobile||n.ipad){e._runForever(function(){e.updateCaret()})}this._attachMouseAndTouchEvents();this._attachClipboardEvents();this._attachDragAndDropListeners()},_attachClipboardEvents:function(){
s.on("copy",this.node,this.handleCommand.bind(this,"copy"));s.on("cut",this.node,this.handleCommand.bind(this,"cut"));s.on("paste",this.node,this.handleCommand.bind(this,"paste"))},_attachMouseAndTouchEvents:function(){var e=this,t=null,n=this.trigger.bind(this,"longpress"),i=this._debugEvent.bind(this);s.on(["mousedown","touchstart"],this.node,function(r,s){if(!t){t=setTimeout(function(){n(r)},500)}i(s,r);setTimeout(e._updateCaretAndFormattingState.bind(e),0);e.trigger(s,r)});s.on(["mouseup","touchend"],this.node,function(n,r){if(t){clearTimeout(t);t=null}i(r,n);setTimeout(e._updateCaretAndFormattingState.bind(e),0);e.trigger(r,n)});s.on(["mousemove","touchmove"],this.node,function(t,n){setTimeout(e._updateCaretAndFormattingState.bind(e),0);e.trigger(n,t)})},_attachDragAndDropListeners:function(){if(n.mobile){return}var e=this,r=false,o=this._debugEvent.bind(this);s.on(["dragstart","dragend"],this.node,function(t,n){o(n,t);r=n=="dragstart";var i=e.caret.start.span.parent,s;if(e.caret.isCollapsed()){
if(!i.isEditable()){e.moveCaret(i.first(),i.last())}else if(t.target.nodeName=="IMG"){s=c.get(t.target.parentElement.parentElement);i=s.parent;e.moveCaret(i.first(),i.last())}}});s.on("drop",this.node,function(n){o("drop",n);var s,a,d,c=[i.PUBLIC_HTML,i.HTML],l,f;if(r){r=false;d=e.cloneSelection()}else{for(l=0;l<c.length;l++){f=n.dataTransfer.getData(c[l]);if(f){d=require("qtext2/parser").parse(f,c[l]);d=e.sanitizeContent(d);break}}d=d||[]}try{s=t.rangeFromPoint(n.clientX,n.clientY);a=e.caret._fromNode(s.startContainer,s.startOffset);e.saveState();e._deleteSelection(true);e.moveCaret(a);e._insertSections(d);n.preventDefault()}catch(h){console.error(h)}})},_attachCommands:function(){var e=require("qtext2/commands").COMMANDS,t=Object.keys(e),n,i,r;for(r=0;r<t.length;r++){i=t[r];n=e[i];if(!this.isDisabledCommand(r)){this._commands[i]=new n(this)}}},_initExtensions:function(){var e=require("qtext2/extensions").EXTENSIONS,t,n,i;for(i=0;i<e.length;i++){t=e[i];n=new t(this);n.install();this._extensions.push(n);
}},_runForever:function(e){var t=this;var n=function(){if(!t._destroyed){try{e()}catch(i){r("Error in _runForever:",i)}finally{window.requestAnimationFrame(n)}}};window.requestAnimationFrame(n)},_beforeTextInput:function(e){var t=this.caret.start.span.parent;if(!this.caret.isCollapsed()){this.saveState();this._deleteSelection(true);t=this.caret.start.span.parent}if(!t.isEditable()){var n=new x;if(this.caret.start.atSectionStart()){this.insertBefore(n,t)}else{this.insertAfter(n,t)}this.moveCaret(n.first());this.caret.updateAndroidCaretPosition(1)}this.formattingState.updatePosition(this.caret)},_afterTextInput:function(){if(this.formattingState.hasChanged(this.caret)){this._applyFormattingChange()}},_updateFormattingState:function(){this.formattingState.update(this.caret)},_applyFormattingChange:function(){var e=this.caret.start.span,t=this.formattingState.position.offset,n=this.caret.start.offset;if(e===this.formattingState.position.span){if(n>t){if(n<e.getLength()){e.split(n,true)}if(t>0){
e=e.split(t,true)}this.formattingState.apply(e);this.moveCaret(e.last());this._updateFormattingState()}else if(n<t){this._updateFormattingState()}else{}}else{this._updateFormattingState()}},_deleteSelection:function(e){var t=this.caret.start,n=this.caret.end,i=t.span.parent,r=n.span.parent,s,o;if(i==r){if(i.isEditable()){i.deleteText(t,n)}else{t=t.span.next().first();this.removeChild(i)}}else{if(i.isEditable()){i.deleteText(t,i.last())}else{s=new x;this.insertBefore(s,i);this.removeChild(i);i=s}while(i.nextSibling()!=r){this.removeChild(i.nextSibling())}if(r.isEditable()){r.deleteText(r.first(),n)}else{s=new x;this.insertBefore(s,r);this.removeChild(r);r=s}t=i.merge(r)}if(t.span.isEmpty()){o=this._handleEmptySpan(t.span,e)}else{o=t}this.moveCaret(o,o,true)},_getSelectedSpans:function(e){this.updateCaret();var t=[],n=this.caret.start,i=this.caret.end;if(this.caret.isCollapsed()){return[]}if(n.span==i.span){if(i.offset<i.span.getLength()){i.span.split(i.offset,e)}if(n.offset>0){i.span=n.span=n.span.split(n.offset,e);
}t=[n.span]}else{if(n.offset>0){if(n.offset==n.span.getLength()){n.span=n.span.next()}else{n.span=n.span.split(n.offset,e)}}if(i.offset<i.span.getLength()){if(i.offset===0){i.span=i.span.previous()}else{i.span.split(i.offset,e)}}for(var r=n.span;r!=i.span;r=r.next()){t.push(r)}t.push(i.span)}this.moveCaret(n.span.first(),i.span.last());return t},_toggleMathOrCodeModifier:function(e){if(this.caret.isCollapsed()){return}var t=this._getSelectedSpans(true),n=t[0].getModifier(e);if(n){t.forEach(function(t){t.removeModifier(e)})}else{t=this._mergeSpansBySection(t);t.forEach(function(t){t.setModifier(e,true,true)});this.moveCaret(t[0].first(),t[t.length-1].last())}this._updateFormattingState()},_getSelectedSections:function(){this.updateCaret();var e=[],t=this.caret.start,n=this.caret.end,i;if(this.caret.isCollapsed()){e.push(t.span.parent)}else{for(i=t.span.parent;i!=n.span.parent;i=i.nextSibling()){e.push(i)}e.push(n.span.parent)}return e},_insertSections:function(e){var t=this,n,i,r,s,a,d,c;
if(e.length===0){return}if(!t.caret.isCollapsed()){t._deleteSelection(true)}this.handleCommand("video",e);n=t.caret.start;r=n.span.parent;if(!r.isEditable()){var l=new x;if(t.caret.start.atSectionStart()){t.insertBefore(l,r)}else{t.insertAfter(l,r)}t.moveCaret(l.first());r=l;n=l.first()}c=o({},n.span.modifiers);r.split(n);s=r.nextSibling();e.forEach(function(e){e.children.forEach(function(t){if(e.isEditable()){t.updateModifiers(c,true)}});t.insertBefore(e,s);if(r instanceof b&&e.isEditable()){e.changeType(b)}t.detectLinksInSection(e);e.setIndent(e.getIndent())});a=r.nextSibling();if(a.constructor==r.constructor||a instanceof x){r.merge(a)}d=s.previousSibling();if(d.isEditable()&&(d.constructor==s.constructor||s instanceof x)){i=d.last();d.merge(s)}else{i=s.first()}this.moveCaret(i)},_shouldAllowLinks:function(e){e=e||this.caret.start.span;var t=e.parent;if(!this.caret.isCollapsed()){return false}if(e.hasModifier("link")){return false}if(t instanceof b||e.hasModifier("code")){return false;
}if(e.hasModifier("math")){return false}return true},_insertOrModifyLink:function(e,t,n,i){var r=this.caret.start,s=!i&&r.span.hasAnyModifier(["link","citation"]),o=s?r.span:new c(e),a=new c(" ");if(!s){o.updateModifiers(r.span.modifiers)}o.removeModifier("link");o.removeModifier("citation");a.updateModifiers(o.modifiers);if(!s){r=this.insertSpan(r,o)}if(!n){o.setModifier("link",t);o.setText(e)}else{o.setModifier("citation",{target:t});o.setText(" ")}r=o.last();this.caret.move(r);if(this.caret.charAfter()!==" "){r=this.insertSpan(r,a);this.caret.move(r)}return o},_previewLink:function(e){var t=this,n,i,a;if(e.hasModifier("link")){a=e.getModifier("link").url}else if(e.hasModifier("citation")){n=e.getModifier("citation");i="target"in n?n.target:n;a=i.url}else{a=e.getText()}if(a.startsWith("mailto:")&&f(a.slice(7))){return}a=s.ensureProtocol(a);this.linkSelector.getLinkPreview(a,function(n){if(e.hasModifier("citation")){e.setModifier("citation",o({title:n.title},e.getModifier("citation")));
}else if(n.type=="image"){t.uploadImageUrl(a,e)}else{e.setText(n.title);if(t.caret.start.span==e){t.moveCaret(e.last());t._updateFormattingState()}}t.saveState()},function(){r("Link preview error",a,arguments)})},_mergeSpansBySection:function(e){var t=null,n=null,i,r=[];e.forEach(function(e){if(e.parent!=n){t=e;n=e.parent;r.push(e)}else{i=s.objectIntersection(t.modifiers,e.modifiers);t.removeAllModifiers();t.updateModifiers(i);t.setText(t.getText()+e.getText());e.parent.removeChild(e)}});return r}});exports.Doc=O});
